<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ph√¢n Lo·∫°i Sinh Vi√™n Theo K·ªπ NƒÉng</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Format ƒëi·ªÉm s·ªë cho ƒë·∫πp - Lo·∫°i b·ªè .0 v√† .00
        function formatScore(score) {
            if (!score && score !== 0) return "N/A";
            // N·∫øu ƒëi·ªÉm l√† s·ªë nguy√™n (10, 9, 8,...), hi·ªÉn th·ªã kh√¥ng c√≥ th·∫≠p ph√¢n
            if (Number.isInteger(score)) return `${score}`;
            // N·∫øu l√† s·ªë th·∫≠p ph√¢n, l√†m tr√≤n ƒë·∫øn 1 ch·ªØ s·ªë v√† b·ªè .0 n·∫øu c√≥
            return score.toFixed(1).replace(/\.0$/, '');
        }
        
        // Format s·ªë th·∫≠p ph√¢n - Lo·∫°i b·ªè .0 v√† .00 kh√¥ng c·∫ßn thi·∫øt
        function formatNumber(num, decimals = 1) {
            if (num === null || num === undefined || isNaN(num)) return "N/A";
            if (Number.isInteger(num)) return `${num}`;
            const fixed = num.toFixed(decimals);
            // Lo·∫°i b·ªè .0, .00 ·ªü cu·ªëi
            return fixed.replace(/\.0+$/, '');
        }
    </script>
    <script>
        // H√†m t√≠nh ƒëi·ªÉm trung b√¨nh
        function calculateAverageScore(student) {
            let totalScore = 0;
            let courseCount = 0;
            
            if (student.courses) {
                Object.values(student.courses).forEach(course => {
                    if (course.score !== undefined) {
                        totalScore += course.score;
                        courseCount++;
                    }
                });
            }
            
            return courseCount > 0 ? totalScore / courseCount : 0;
        }
        
        // H√†m t√≠nh T·ªîNG th·ªùi gian h·ªçc (kh√¥ng ph·∫£i trung b√¨nh)
        function calculateTotalTime(student) {
            let totalTime = 0;
            
            if (student.courses) {
                Object.values(student.courses).forEach(course => {
                    if (course.time_minutes !== undefined) {
                        totalTime += course.time_minutes;
                    }
                });
            }
            
            return totalTime;
        }
        
        // H√†m t√≠nh th·ªùi gian trung b√¨nh m·ªói m√¥n (ƒë·ªÉ t∆∞∆°ng th√≠ch code c≈©)
        function calculateAverageTime(student) {
            const totalTime = calculateTotalTime(student);
            const courseCount = Object.keys(student.courses || {}).length;
            return courseCount > 0 ? totalTime / courseCount : 0;
        }
        
        // H√†m format th·ªùi gian
        function formatTime(minutes) {
            if (typeof minutes !== 'number') return "0h 0m";
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            return `${hours}h ${mins}m`;
        }
        
        // H√†m x√°c ƒë·ªãnh level cu·ªëi c√πng - ∆Øu ti√™n k·∫øt qu·∫£ K-means/KNN t·ª´ server
        function determineFinalLevel(student, levelNames) {
            // ∆Øu ti√™n d√πng final_level t·ª´ K-means/KNN
            if (student.final_level) {
                return student.final_level;
            }
            
            // Fallback: t√≠nh to√°n n·∫øu kh√¥ng c√≥ t·ª´ server
            const avgScore = calculateAverageScore(student);
            
            if (avgScore >= 8.5) return 'Xuat sac';
            if (avgScore >= 7.0) return 'Kha';
            if (avgScore >= 5.0) return 'Trung binh';
            return 'Yeu';
        }
        
        // H√†m ph√¢n t√≠ch v·∫•n ƒë·ªÅ c·ªßa sinh vi√™n (d√πng chung cho t·∫•t c·∫£ c√°c ph·∫ßn)
        function analyzeStudentIssues(student) {
            const courses = student.courses || {};
            const csvData = student.csv_data || {};
            
            const courseValues = Object.values(courses);
            const avgScore = courseValues.reduce((sum, c) => sum + (c.score || 0), 0) / (courseValues.length || 1);
            const totalTime = courseValues.reduce((sum, c) => sum + (c.time_minutes || 0), 0);
            const timeInHours = totalTime / 60;
            const attendance = parseFloat(csvData.attendance_rate || 0) * 100;
            const lateSubmissions = parseInt(csvData.late_submissions || 0);
            
            const courseScores = courseValues.map(c => c.score || 0);
            const scoreStdDev = courseScores.length > 0 ? 
                Math.sqrt(courseScores.reduce((sum, s) => sum + Math.pow(s - avgScore, 2), 0) / courseScores.length) : 0;
            
            let issues = [];
            let hasAnomaly = student.anomaly_detected || false;
            
            // 1. ƒêi·ªÉm cao + th·ªùi gian ng·∫Øn (nghi gian l·∫≠n/d√πng AI)
            // Sinh vi√™n xu·∫•t s·∫Øc c·∫ßn √≠t nh·∫•t 8-10h, kh√° c·∫ßn 6-8h
            if (avgScore >= 8.5 && timeInHours < 4) {
                issues.push({ text: `ƒêi·ªÉm ${avgScore.toFixed(1)}/10 nh∆∞ng th·ªùi gian ch·ªâ ${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m (nghi gian l·∫≠n)`, severity: 'critical', points: 15, type: 'anomaly' });
                hasAnomaly = true;
            } else if (avgScore >= 8.0 && timeInHours < 3) {
                issues.push({ text: `ƒêi·ªÉm ${avgScore.toFixed(1)}/10 nh∆∞ng th·ªùi gian ch·ªâ ${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m (ƒë√°ng nghi)`, severity: 'high', points: 10, type: 'anomaly' });
                hasAnomaly = true;
            } else if (avgScore >= 7.0 && timeInHours < 2) {
                issues.push({ text: `ƒêi·ªÉm ${avgScore.toFixed(1)}/10 nh∆∞ng th·ªùi gian qu√° ng·∫Øn ${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m`, severity: 'medium', points: 8, type: 'anomaly' });
                hasAnomaly = true;
            }
            
            // 2. Th·ªùi gian h·ªçc qu√° ng·∫Øn
            if (timeInHours < 1.5) {
                issues.push({ text: `Th·ªùi gian h·ªçc qu√° ng·∫Øn (${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m)`, severity: 'high', points: 12, type: 'warning' });
            } else if (timeInHours < 5) {
                issues.push({ text: `Th·ªùi gian h·ªçc th·∫•p (${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m), c·∫ßn tƒÉng ƒë√°ng k·ªÉ`, severity: 'medium', points: 6, type: 'warning' });
            }
            
            // 3. Tham gia l·ªõp th·∫•p
            if (attendance < 50 && avgScore >= 9.0) {
                issues.push({ text: `V·∫Øng m·∫∑t ${Math.round(100-attendance)}% nh∆∞ng ƒëi·ªÉm v·∫´n cao (${avgScore.toFixed(1)}/10)`, severity: 'critical', points: 12, type: 'anomaly' });
                hasAnomaly = true;
            } else if (attendance < 50) {
                issues.push({ text: `Tham gia l·ªõp qu√° th·∫•p (${Math.round(attendance)}%)`, severity: 'high', points: 8, type: 'warning' });
            } else if (attendance < 70) {
                issues.push({ text: `Tham gia l·ªõp th·∫•p (${Math.round(attendance)}%), c·∫ßn c·∫£i thi·ªán`, severity: 'medium', points: 4, type: 'warning' });
            }
            
            // 4. N·ªôp tr·ªÖ nhi·ªÅu
            if (lateSubmissions >= 15) {
                issues.push({ text: `N·ªôp b√†i tr·ªÖ nhi·ªÅu (${lateSubmissions} l·∫ßn)`, severity: 'high', points: 12, type: 'warning' });
            } else if (lateSubmissions >= 10) {
                issues.push({ text: `N·ªôp b√†i tr·ªÖ ${lateSubmissions} l·∫ßn`, severity: 'medium', points: 8, type: 'warning' });
            } else if (lateSubmissions >= 5) {
                issues.push({ text: `N·ªôp b√†i tr·ªÖ ${lateSubmissions} l·∫ßn - c·∫ßn c·∫£i thi·ªán k·ª∑ lu·∫≠t`, severity: 'low', points: 4, type: 'warning' });
            }
            
            // 5. ƒêi·ªÉm s·ªë th·∫•p - C·∫ßn c·∫£i thi·ªán
            if (avgScore < 4.0) {
                issues.push({ text: `ƒêi·ªÉm s·ªë (${avgScore.toFixed(1)}/10) qu√° th·∫•p, c·∫ßn n·ªó l·ª±c nhi·ªÅu h∆°n`, severity: 'high', points: 10, type: 'warning' });
            } else if (avgScore < 5.0) {
                issues.push({ text: `ƒêi·ªÉm s·ªë (${avgScore.toFixed(1)}/10) d∆∞·ªõi trung b√¨nh, c·∫ßn c·∫£i thi·ªán`, severity: 'medium', points: 6, type: 'warning' });
            }
            
            // 6. ƒêi·ªÉm ch√™nh l·ªách l·ªõn - TƒÉng ng∆∞·ª°ng
            if (scoreStdDev > 3.5 && avgScore >= 8.0) {
                issues.push({ text: `ƒêi·ªÉm c√°c m√¥n ch√™nh l·ªách l·ªõn (ƒë·ªô l·ªách: ${scoreStdDev.toFixed(1)})`, severity: 'high', points: 10, type: 'anomaly' });
                hasAnomaly = true;
            }
            
            // 7. ƒêi·ªÉm tƒÉng ƒë·ªôt ng·ªôt - Ng∆∞·ª°ng ch·∫∑t h∆°n
            const midtermScore = parseFloat(csvData.midterm_score || 0);
            if (midtermScore < 4.0 && avgScore >= 9.5) {
                issues.push({ text: `ƒêi·ªÉm tƒÉng ƒë·ªôt ng·ªôt (gi·ªØa k·ª≥ ${midtermScore.toFixed(1)} ‚Üí b√†i t·∫≠p ${avgScore.toFixed(1)})`, severity: 'critical', points: 15, type: 'anomaly' });
                hasAnomaly = true;
            }
            
            // Th√™m l√Ω do t·ª´ server n·∫øu c√≥ (anomaly_reasons l√† array)
            const serverReasons = student.anomaly_reasons || [];
            if (Array.isArray(serverReasons)) {
                serverReasons.forEach(reason => {
                    if (reason && !issues.some(i => i.text.includes(reason.substring(0, 20)))) {
                        issues.push({ text: reason, severity: 'high', points: 10 });
                    }
                });
            } else if (student.anomaly_reason && !issues.some(i => i.text === student.anomaly_reason)) {
                issues.push({ text: student.anomaly_reason, severity: 'high', points: 10 });
            }
            
            // L·∫•y behavior t·ª´ csv_data
            const behavior = parseInt(csvData.behavior_score_100 || 0);
            
            return {
                issues: issues,
                hasAnomaly: hasAnomaly,
                totalPenalty: issues.reduce((sum, i) => sum + i.points, 0),
                stats: { avgScore, timeInHours, totalTime, attendance, lateSubmissions, scoreStdDev, midtermScore, behavior }
            };
        }
        
        // H√†m c·∫≠p nh·∫≠t b·∫£ng ph√¢n t√≠ch theo m√¥n h·ªçc
        function updateScoreTable(studentId) {
            const filterSelect = document.getElementById(`courseFilter_${studentId}`);
            const selectedCourse = filterSelect.value;
            
            // ƒê·ªìng b·ªô v·ªõi b·ªô l·ªçc chi ti·∫øt m√¥n h·ªçc
            const modalFilter = document.getElementById(`modalCourseFilter_${studentId}`);
            if (modalFilter && modalFilter.value !== selectedCourse) {
                modalFilter.value = selectedCourse;
                // L·ªçc c√°c m√¥n h·ªçc hi·ªÉn th·ªã
                const courseItems = document.querySelectorAll('.course-detail-item');
                courseItems.forEach(item => {
                    const courseName = item.getAttribute('data-course');
                    if (selectedCourse === 'all' || courseName === selectedCourse) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
            
            // T√¨m student trong d·ªØ li·ªáu
            const student = window.studentsData.find(s => s.student_id === studentId);
            if (!student) return;
            
            const courses = student.courses || {};
            const csvData = student.csv_data || {};
            
            let filteredCourses = courses;
            let courseLabel = "T·∫•t c·∫£ m√¥n";
            
            if (selectedCourse !== 'all') {
                filteredCourses = { [selectedCourse]: courses[selectedCourse] };
                courseLabel = selectedCourse;
            }
            
            // T√≠nh to√°n l·∫°i c√°c gi√° tr·ªã
            const courseValues = Object.values(filteredCourses);
            const avgScore = courseValues.reduce((sum, c) => sum + (c.score || 0), 0) / courseValues.length;
            const totalTime = courseValues.reduce((sum, c) => sum + (c.time_minutes || 0), 0);
            const timeInHours = totalTime / 60;
            
            const attendance = parseFloat(csvData.attendance_rate || 0) * 100;
            const totalLateSubmissions = parseInt(csvData.late_submissions || 0);
            
            const courseScores = courseValues.map(c => c.score || 0);
            const scoreStdDev = courseScores.length > 0 ? Math.sqrt(courseScores.reduce((sum, s) => sum + Math.pow(s - avgScore, 2), 0) / courseScores.length) : 0;
            
            // C·∫≠p nh·∫≠t b·∫£ng
            const container = document.getElementById(`scoreTableContainer_${studentId}`);
            container.innerHTML = `
                <div style="background: #e3f2fd; padding: 8px 12px; border-radius: 5px; margin-bottom: 10px; font-weight: bold; color: #1976d2;">
                    üìñ ƒêang xem: ${courseLabel}
                </div>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 10px; text-align: left; border-radius: 5px 0 0 0;">Y·∫øu t·ªë</th>
                            <th style="padding: 10px; text-align: center; border-radius: 0 5px 0 0;">Gi√° tr·ªã</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: white;">
                            <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>üìä ƒêi·ªÉm trung b√¨nh</strong></td>
                            <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${avgScore >= 8 ? '#28a745' : avgScore >= 6.5 ? '#17a2b8' : avgScore >= 5 ? '#ffc107' : '#dc3545'};">${avgScore.toFixed(1)}/10</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>‚è±Ô∏è T·ªïng th·ªùi gian h·ªçc</strong></td>
                            <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${timeInHours >= 10 ? '#28a745' : timeInHours >= 5 ? '#17a2b8' : '#ffc107'};">${Math.floor(timeInHours)}h ${Math.round(totalTime % 60)}m</td>
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>‚úÖ T·ª∑ l·ªá tham d·ª±</strong></td>
                            <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${attendance >= 80 ? '#28a745' : attendance >= 60 ? '#ffc107' : '#dc3545'};">${Math.round(attendance)}%</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>üìù N·ªôp b√†i tr·ªÖ</strong></td>
                            <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${totalLateSubmissions <= 3 ? '#28a745' : totalLateSubmissions <= 8 ? '#ffc107' : '#dc3545'};">${totalLateSubmissions} l·∫ßn</td>
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>üìà T√≠nh nh·∫•t qu√°n ƒëi·ªÉm</strong></td>
                            <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${scoreStdDev < 1 ? '#28a745' : scoreStdDev < 2 ? '#ffc107' : '#dc3545'};">${scoreStdDev < 1 ? '·ªîn ƒë·ªãnh' : scoreStdDev < 2 ? 'Trung b√¨nh' : 'Kh√¥ng ·ªïn ƒë·ªãnh'}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }
        
        // H√†m gi·∫£i th√≠ch level
        // H√†m t√≠nh level d·ª±a tr√™n ƒëi·ªÉm ch·∫•m l·∫°i (d√πng chung cho c·∫£ danh s√°ch v√† chi ti·∫øt)
        function calculateStudentLevel(student) {
            // ∆Øu ti√™n d√πng final_level t·ª´ server (ƒë√£ ph√¢n lo·∫°i b·∫±ng KMeans/KNN)
            if (student.final_level) {
                // Chu·∫©n h√≥a v·ªÅ format kh√¥ng d·∫•u
                const levelMap = {
                    'Xu·∫•t s·∫Øc': 'Xuat sac',
                    'Kh√°': 'Kha',
                    'Trung b√¨nh': 'Trung binh',
                    'Y·∫øu': 'Yeu'
                };
                return levelMap[student.final_level] || student.final_level;
            }
            
            // Fallback: t√≠nh l·∫°i n·∫øu kh√¥ng c√≥ final_level
            const avgScore = Object.values(student.courses || {}).reduce((sum, course) => sum + (course.score || 0), 0) / Object.keys(student.courses || {}).length;
            const avgTime = Object.values(student.courses || {}).reduce((sum, course) => sum + (course.time_minutes || 0), 0) / Object.keys(student.courses || {}).length;
            const timeInHours = avgTime / 60;
            const csvData = student.csv_data || {};
            const attendance = parseFloat(csvData.attendance_rate || 0) * 100;
            const lateSubmissions = parseInt(csvData.late_submissions || 0);
            
            // T√≠nh t·ªïng s·ªë b√†i t·∫≠p (gi·∫£ s·ª≠ m·ªói m√¥n c√≥ 30 b√†i, 4 m√¥n = 120 b√†i)
            const totalAssignments = Object.keys(student.courses || {}).length * 30;
            const lateRate = totalAssignments > 0 ? (lateSubmissions / totalAssignments) * 100 : 0;
            
            // T√≠nh ƒëi·ªÉm c√°c y·∫øu t·ªë (35% ƒëi·ªÉm, 25% th·ªùi gian, 20% tham gia, 10% k·ª∑ lu·∫≠t, 10% nh·∫•t qu√°n)
            
            // 1. ƒêi·ªÉm s·ªë (35%)
            let scorePoints = 0;
            if (avgScore >= 9.0) scorePoints = 35;
            else if (avgScore >= 8.0) scorePoints = 30;
            else if (avgScore >= 7.0) scorePoints = 25;
            else if (avgScore >= 6.0) scorePoints = 20;
            else if (avgScore >= 5.0) scorePoints = 15;
            else scorePoints = 8;
            
            // 2. Th·ªùi gian h·ªçc (25%) - ƒêi·ªÅu ch·ªânh ƒë·ªÉ linh ho·∫°t h∆°n
            let timePoints = 0;
            if (timeInHours >= 15) timePoints = 25;
            else if (timeInHours >= 12) timePoints = 23;
            else if (timeInHours >= 10) timePoints = 20;
            else if (timeInHours >= 8) timePoints = 17;
            else if (timeInHours >= 5) timePoints = 14;
            else if (timeInHours >= 3) timePoints = 10;
            else timePoints = 5;
            
            // 3. Tham gia l·ªõp (20%) - ƒêi·ªÅu ch·ªânh ƒë·ªÉ linh ho·∫°t h∆°n
            let attendancePoints = 0;
            if (attendance >= 95) attendancePoints = 20;
            else if (attendance >= 90) attendancePoints = 18;
            else if (attendance >= 85) attendancePoints = 16;
            else if (attendance >= 80) attendancePoints = 15;
            else if (attendance >= 70) attendancePoints = 12;
            else if (attendance >= 60) attendancePoints = 10;
            else if (attendance >= 50) attendancePoints = 7;
            else attendancePoints = 4;
            
            // 4. K·ª∑ lu·∫≠t - D·ª±a tr√™n T·ª∂ L·ªÜ n·ªôp mu·ªôn (10%)
            // T√≠nh ƒëi·ªÉm tuy·∫øn t√≠nh: 10 ƒëi·ªÉm khi 0% n·ªôp mu·ªôn, 0 ƒëi·ªÉm khi >= 50% n·ªôp mu·ªôn
            let behaviorPoints = Math.max(0, 10 - (lateRate / 5));
            behaviorPoints = Math.round(behaviorPoints * 10) / 10; // L√†m tr√≤n 1 ch·ªØ s·ªë th·∫≠p ph√¢n
            
            const courseScores = Object.values(student.courses || {}).map(c => c.score || 0);
            const scoreStdDev = courseScores.length > 0 ? 
                Math.sqrt(courseScores.reduce((sum, s) => sum + Math.pow(s - avgScore, 2), 0) / courseScores.length) : 0;
            let consistencyPoints = 0;
            if (scoreStdDev < 0.5) consistencyPoints = 10;
            else if (scoreStdDev < 1.0) consistencyPoints = 8;
            else if (scoreStdDev < 1.5) consistencyPoints = 6;
            else if (scoreStdDev < 2.0) consistencyPoints = 4;
            else consistencyPoints = 2;
            
            const totalPoints = scorePoints + timePoints + attendancePoints + behaviorPoints + consistencyPoints;
            
            // T√≠nh penalty - CH·ªà PH·∫†T TR∆Ø·ªúNG H·ª¢P C·ª∞C ƒêOAN ƒë·ªÉ k·∫øt qu·∫£ ·ªïn ƒë·ªãnh
            let totalPenalty = 0;
            
            // 1. N·ªôp b√†i C·ª∞C nhanh (< 0.3 ph√∫t/b√†i) - R√µ r√†ng l√† gian l·∫≠n
            const avgTimePerExercise = avgTime / 30;
            if (avgTimePerExercise < 0.3 && avgScore >= 9.0) {
                totalPenalty += 15;
            }
            
            // 2. ƒêi·ªÉm C·ª∞C cao v·ªõi th·ªùi gian C·ª∞C ng·∫Øn - Ch·ªâ ph·∫°t tr∆∞·ªùng h·ª£p c·ª±c ƒëoan
            if (avgScore >= 9.8 && timeInHours < 1.5) {
                totalPenalty += 20;
            } else if (avgScore >= 9.5 && timeInHours < 2) {
                totalPenalty += 12;
            }
            
            // 3. N·ªôp mu·ªôn QU√Å nhi·ªÅu
            if (lateSubmissions >= 20) {
                totalPenalty += 10;
            } else if (lateSubmissions >= 15) {
                totalPenalty += 6;
            }
            
            // 4. ƒêi·ªÉm kh√¥ng nh·∫•t qu√°n C·ª∞C ƒë·ªô
            if (scoreStdDev > 4.5 && avgScore >= 9.0) {
                totalPenalty += 8;
            }
            
            // 5. V·∫Øng QU√Å nhi·ªÅu nh∆∞ng ƒëi·ªÉm cao
            if (attendance < 30 && avgScore >= 9.5) {
                totalPenalty += 12;
            } else if (attendance < 40 && avgScore >= 9.8) {
                totalPenalty += 8;
            }
            
            // 6. ƒêi·ªÉm tƒÉng ƒê·ªòT NG·ªòT b·∫•t th∆∞·ªùng
            const midtermScore = parseFloat(csvData.midterm_score || 0);
            if (midtermScore < 3.0 && avgScore >= 9.8) {
                totalPenalty += 15;
            } else if (midtermScore < 4.0 && avgScore >= 9.5) {
                totalPenalty += 8;
            }
            
            const finalPoints = Math.max(0, totalPoints - totalPenalty);
            
            // X√°c ƒë·ªãnh level - C√ÇN B·∫∞NG NG∆Ø·ª†NG
            if (finalPoints >= 85) return "Xuat sac";
            else if (finalPoints >= 70) return "Kha";
            else if (finalPoints >= 52) return "Trung binh";
            else return "Yeu";
        }
        
        function explainLevel(student) {
            // S·ª≠ d·ª•ng ƒëi·ªÉm t·ª´ courses (gi·ªëng nh∆∞ ph·∫ßn Gi·∫£i th√≠ch x·∫øp lo·∫°i)
            const avgScore = Object.values(student.courses || {}).reduce((sum, course) => sum + (course.score || 0), 0) / Object.keys(student.courses || {}).length;
            // D√πng T·ªîNG th·ªùi gian (kh√¥ng ph·∫£i trung b√¨nh)
            const totalTime = Object.values(student.courses || {}).reduce((sum, course) => sum + (course.time_minutes || 0), 0);
            const timeInHours = totalTime / 60;
            
            const csvData = student.csv_data || {};
            const attendance = parseFloat(csvData.attendance_rate || 0) * 100;
            const lateSubmissions = parseInt(csvData.late_submissions || 0);
            const level = student.final_level;
            
            let explanation = '<div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea;">';
            explanation += '<h4 style="color: #667eea; margin-bottom: 10px;">üí° Ph√¢n t√≠ch chi ti·∫øt:</h4>';
            
            // Ph√¢n t√≠ch ƒëi·ªÉm s·ªë theo level
            let scoreAnalysis = '';
            if (level === 'Xuat sac') {
                scoreAnalysis = `ƒêi·ªÉm s·ªë xu·∫•t s·∫Øc (${formatNumber(avgScore)}/10) cho th·∫•y kh·∫£ nƒÉng n·∫Øm v·ªØng ki·∫øn th·ª©c`;
            } else if (level === 'Kha') {
                scoreAnalysis = `ƒêi·ªÉm s·ªë kh√° (${formatNumber(avgScore)}/10) th·ªÉ hi·ªán s·ª± hi·ªÉu bi·∫øt t·ªët v·ªÅ c√°c m√¥n h·ªçc`;
            } else if (level === 'Trung binh') {
                scoreAnalysis = `ƒêi·ªÉm s·ªë trung b√¨nh (${formatNumber(avgScore)}/10) c·∫ßn c·ªßng c·ªë th√™m ki·∫øn th·ª©c`;
            } else {
                scoreAnalysis = `ƒêi·ªÉm s·ªë (${formatNumber(avgScore)}/10) c·∫ßn n·ªó l·ª±c nhi·ªÅu h∆°n`;
            }

            // Ph√¢n t√≠ch th·ªùi gian h·ªçc
            let studyAnalysis = '';
            if (timeInHours >= 15) {
                studyAnalysis = `Th·ªùi gian h·ªçc (${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m) h·ª£p l√Ω`;
            } else if (timeInHours >= 10) {
                studyAnalysis = `Th·ªùi gian h·ªçc (${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m) h∆°i th·∫•p, n√™n tƒÉng th√™m`;
            } else {
                studyAnalysis = `Th·ªùi gian h·ªçc (${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m) qu√° th·∫•p, c·∫ßn tƒÉng ƒë√°ng k·ªÉ`;
            }

            // Ph√¢n t√≠ch tham gia
            let attendanceAnalysis = '';
            if (attendance >= 90) {
                attendanceAnalysis = `Tham gia l·ªõp (${Math.round(attendance)}%) r·∫•t t·ªët`;
            } else if (attendance >= 80) {
                attendanceAnalysis = `Tham gia l·ªõp (${Math.round(attendance)}%) kh√° t·ªët`;
            } else if (attendance >= 70) {
                attendanceAnalysis = `Tham gia l·ªõp (${Math.round(attendance)}%) c·∫ßn c·∫£i thi·ªán`;
            } else {
                attendanceAnalysis = `Tham gia l·ªõp (${Math.round(attendance)}%) qu√° th·∫•p`;
            }

            explanation += `
                <p style="margin-bottom: 8px"><strong>üìä ƒêi·ªÉm s·ªë:</strong> ${scoreAnalysis}</p>
                <p style="margin-bottom: 8px"><strong>‚è∞ Th·ªùi gian h·ªçc:</strong> ${studyAnalysis}</p>
                <p style="margin-bottom: 8px"><strong>‚úÖ Tham gia:</strong> ${attendanceAnalysis}</p>
            `;
            
            // C·∫£nh b√°o n·∫øu c√≥ v·∫•n ƒë·ªÅ (ƒë·ªìng b·ªô v·ªõi ph·∫ßn Gi·∫£i th√≠ch x·∫øp lo·∫°i)
            if (lateSubmissions >= 5) {
                explanation += `<p style="margin-bottom: 8px; color: #f44336;"><strong>‚ö†Ô∏è N·ªôp mu·ªôn:</strong> ${lateSubmissions} l·∫ßn - C·∫ßn c·∫£i thi·ªán t√≠nh k·ª∑ lu·∫≠t</p>`;
            }
            
            // C·∫£nh b√°o b·∫•t th∆∞·ªùng - Ch·ªâ c·∫£nh b√°o tr∆∞·ªùng h·ª£p c·ª±c ƒëoan
            if (avgScore >= 9.5 && timeInHours < 2) {
                explanation += `<p style="margin-bottom: 8px; color: #ff9800;"><strong>‚ö†Ô∏è B·∫•t th∆∞·ªùng:</strong> ƒêi·ªÉm ${formatNumber(avgScore)}/10 cao b·∫•t th∆∞·ªùng v·ªõi th·ªùi gian ${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m - C·∫ßn ki·ªÉm tra l·∫°i</p>`;
            } else if (avgScore >= 9.8 && timeInHours < 3) {
                explanation += `<p style="margin-bottom: 8px; color: #ff9800;"><strong>‚ö†Ô∏è B·∫•t th∆∞·ªùng:</strong> ƒêi·ªÉm cao nh∆∞ng th·ªùi gian qu√° ng·∫Øn - Nghi v·∫•n s·ª≠ d·ª•ng AI ho·∫∑c s√°ch gi·∫£i</p>`;
            }
            
            explanation += '</div>';
            return explanation;
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            color: #666;
            font-size: 1.2em;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
        }
        
        .controls > * {
            min-width: 0;
        }

        select {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: border-color 0.3s;
            width: 100%;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            white-space: nowrap;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* Save Dropdown Menu */
        .save-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .save-menu {
            animation: fadeIn 0.2s ease;
        }
        
        .save-menu > div:hover {
            background: #f5f5f5;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input[type="number"],
        input[type="text"] {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            width: 100%;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            text-align: center;
            transition: all 0.3s;
            border-top: 4px solid #667eea;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
            font-weight: 600;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            color: #666;
            font-size: 0.9em;
            margin: 0;
        }

        .stat-card.xuat-sac { 
            border-top: 5px solid #4CAF50;
            background: linear-gradient(135deg, #ffffff 0%, #f1f8f4 100%);
        }
        .stat-card.xuat-sac .number { color: #4CAF50; }

        .stat-card.kha { 
            border-top: 5px solid #2196F3;
            background: linear-gradient(135deg, #ffffff 0%, #f1f4f8 100%);
        }
        .stat-card.kha .number { color: #2196F3; }

        .stat-card.trung-binh { 
            border-top: 5px solid #FF9800;
            background: linear-gradient(135deg, #ffffff 0%, #fff8f1 100%);
        }
        .stat-card.trung-binh .number { color: #FF9800; }

        .stat-card.yeu { 
            border-top: 5px solid #f44336;
            background: linear-gradient(135deg, #ffffff 0%, #fff5f5 100%);
        }
        .stat-card.yeu .number { color: #f44336; }

        /* Ph√¢n v√πng m√¥n h·ªçc */
        .courses-section {
            margin-bottom: 30px;
        }

        .course-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .course-tab {
            background: white;
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid transparent;
        }

        .course-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .course-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .course-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
        }

        .course-content.active {
            display: block;
        }

        .course-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .course-header h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 15px;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            width: 100%;
        }

        .student-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .student-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.4em;
            font-weight: 700;
        }

        .student-card .level {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.95em;
            font-weight: bold;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .level.xuat-sac { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; }
        .level.kha { background: linear-gradient(135deg, #2196F3 0%, #1e88e5 100%); color: white; }
        .level.trung-binh { background: linear-gradient(135deg, #FF9800 0%, #fb8c00 100%); color: white; }
        .level.yeu { background: linear-gradient(135deg, #f44336 0%, #e53935 100%); color: white; }

        .anomaly {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 5px solid #f44336;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: 600;
            color: #c62828;
        }

        .course-info {
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .course-info strong {
            color: #667eea;
            font-size: 1.1em;
        }

        .skills-summary {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }

        .skills-summary h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .skill-item {
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .skill-item:hover {
            background: #e9ecef;
        }

        .skill-item.passed { border-left: 4px solid #4CAF50; }
        .skill-item.failed { border-left: 4px solid #f44336; }

        .skill-name {
            flex: 1;
            font-weight: 500;
        }

        .skill-score {
            font-weight: bold;
            margin: 0 10px;
        }

        .skill-status {
            font-size: 1.2em;
        }

        .skill-item.passed .skill-score { color: #4CAF50; }
        .skill-item.failed .skill-score { color: #f44336; }

        .loading {
            text-align: center;
            padding: 60px;
            color: white;
            font-size: 1.3em;
            font-weight: 600;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #status {
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            margin-left: auto;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow: auto;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #000;
        }

        .charts-section {
            margin-bottom: 30px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .chart-card:hover {
            transform: translateY(-5px);
        }

        .chart-card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
            padding: 15px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .students-grid {
                grid-template-columns: 1fr;
            }
            .course-tabs {
                flex-direction: column;
            }
            .course-tab {
                width: 100%;
            }
        }
    </style>
</head>
<body>
        <div class="container">
        <header>
            <h1>üéì H·ªá Th·ªëng Ph√¢n Lo·∫°i Sinh Vi√™n Theo K·ªπ NƒÉng</h1>
            <p class="subtitle">Ph√¢n t√≠ch ƒëi·ªÉm s·ªë, th·ªùi gian v√† ph√°t hi·ªán gian l·∫≠n</p>
        </header>

        <!-- ƒêi·ªÅu khi·ªÉn -->
        <div class="controls">
            <input type="text" id="studentSearchInput" placeholder="üîé T√¨m sinh vi√™n (t√™n ho·∫∑c MSSV)" oninput="searchStudents()">
            <input type="text" id="classSearchInput" placeholder="üîé Nh·∫≠p m√£ l·ªõp (VD: 22CT111)">
            <button onclick="searchByClass()">üîé T√¨m l·ªõp</button>
            <select id="classFilter" onchange="filterByClass()">
                <option value="">üè´ T·∫•t c·∫£ l·ªõp</option>
            </select>
            <select id="courseFilter" onchange="filterByCourse()">
                <option value="">üìö T·∫•t c·∫£ m√¥n h·ªçc</option>
            </select>
            <button id="toggleViewBtn" onclick="toggleViewMode()">üóíÔ∏è Ch·∫ø ƒë·ªô: Danh s√°ch</button>
            
            <!-- N√∫t L∆∞u D·ªØ Li·ªáu (G·ªôp) -->
            <div class="save-dropdown" style="position: relative; display: inline-block;">
                <button onclick="toggleSaveMenu()" id="saveBtn" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                    üíæ L∆∞u D·ªØ Li·ªáu ‚ñº
                </button>
                <div id="saveMenu" class="save-menu" style="display: none; position: absolute; top: 100%; left: 0; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; min-width: 200px; margin-top: 5px;">
                    <div onclick="saveAllToSupabase()" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">‚òÅÔ∏è</span>
                        <div>
                            <div style="font-weight: 600; color: #333;">L∆∞u l√™n Supabase</div>
                            <div style="font-size: 11px; color: #666;">ƒê·ªìng b·ªô l√™n cloud</div>
                        </div>
                    </div>
                    <div onclick="downloadCurrentList(); toggleSaveMenu();" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">üì•</span>
                        <div>
                            <div style="font-weight: 600; color: #333;">T·∫£i danh s√°ch (CSV)</div>
                            <div style="font-size: 11px; color: #666;">Xu·∫•t file CSV</div>
                        </div>
                    </div>
                    <div onclick="downloadByClass(); toggleSaveMenu();" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">üè´</span>
                        <div>
                            <div style="font-weight: 600; color: #333;">T·∫£i theo l·ªõp</div>
                            <div style="font-size: 11px; color: #666;">Xu·∫•t theo l·ªõp ƒëang ch·ªçn</div>
                        </div>
                    </div>
                    <div onclick="downloadByCourse(); toggleSaveMenu();" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">üìö</span>
                        <div>
                            <div style="font-weight: 600; color: #333;">T·∫£i theo m√¥n</div>
                            <div style="font-size: 11px; color: #666;">Xu·∫•t theo m√¥n ƒëang ch·ªçn</div>
                        </div>
                    </div>
                    <div onclick="downloadScoreReport(); toggleSaveMenu();" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">üìä</span>
                        <div>
                            <div style="font-weight: 600; color: #333;">T·∫£i b·∫£ng ƒëi·ªÉm chi ti·∫øt</div>
                            <div style="font-size: 11px; color: #666;">ƒêi·ªÉm t·ª´ng m√¥n + k·ªπ nƒÉng</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="statsContainer" class="stats"></div>

        <!-- Bi·ªÉu ƒë·ªì th·ªëng k√™ -->
        <div class="charts-section">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üìä Ph√¢n B·ªë Sinh Vi√™n Theo M·ª©c ƒê·ªô</h3>
                    <div class="chart-container">
                        <canvas id="levelChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üìà ƒêi·ªÉm Trung B√¨nh Theo M√¥n H·ªçc</h3>
                    <div class="chart-container">
                        <canvas id="courseScoreChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üéØ T·ª∑ L·ªá K·ªπ NƒÉng ƒê·∫°t Theo M√¥n</h3>
                    <div class="chart-container">
                        <canvas id="skillPassChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>‚è±Ô∏è Ph√¢n B·ªë Th·ªùi Gian L√†m B√†i</h3>
                    <div class="chart-container">
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh s√°ch sinh vi√™n t·ªïng h·ª£p -->
        <div id="studentsList" class="students-list" style="margin:20px 0;"></div>
    </div>

    <!-- Modal chi ti·∫øt sinh vi√™n -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
    let currentCourse = null;
    let currentClass = '';
    let coursesData = {};
    let allStudents = [];
    let skillEvaluations = {};
    let uniqueClasses = new Set();
    // UI state
    window.viewMode = localStorage.getItem('viewMode') || 'grid'; // L∆∞u ch·∫ø ƒë·ªô xem
    let lastRenderedStudents = [];
    
    // C·∫≠p nh·∫≠t n√∫t chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô xem khi t·∫£i trang
    window.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('toggleViewBtn');
        if (btn) {
            btn.textContent = window.viewMode === 'table' ? 'üóíÔ∏è Ch·∫ø ƒë·ªô: Danh s√°ch' : 'üî≤ Ch·∫ø ƒë·ªô: L∆∞·ªõi';
        }
        // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
        loadStudents();
    });

        // ƒê·ªãnh nghƒ©a 4 m√¥n h·ªçc
        const COURSES = {
            "Nh·∫≠p M√¥n L·∫≠p Tr√¨nh": {
                skills: ["C√∫ ph√°p c∆° b·∫£n (Syntax)", "Bi·∫øn v√† Ki·ªÉu d·ªØ li·ªáu (Variables & Data Types)", 
                       "C·∫•u tr√∫c ƒëi·ªÅu khi·ªÉn (Control Structures)", "H√†m c∆° b·∫£n (Basic Functions)"],
                icon: "üìù"
            },
            "Kƒ© Thu·∫≠t L·∫≠p Tr√¨nh": {
                skills: ["Thi·∫øt k·∫ø thu·∫≠t to√°n (Algorithm Design)", "T·ªëi ∆∞u h√≥a m√£ ngu·ªìn (Code Optimization)",
                       "X·ª≠ l√Ω l·ªói v√† Debugging (Error Handling)", "L·∫≠p tr√¨nh c√≥ c·∫•u tr√∫c (Structured Programming)"],
                icon: "‚öôÔ∏è"
            },
            "C·∫•u tr√∫c D·ªØ Li·ªáu v√† Gi·∫£i Thu·∫≠t": {
                skills: ["M·∫£ng (Arrays)", "Danh s√°ch li√™n k·∫øt (Linked Lists)",
                       "Stack v√† Queue", "C√¢y (Trees)"],
                icon: "üå≥"
            },
            "L·∫≠p Tr√¨nh H∆∞·ªõng ƒê·ªëi T∆∞·ª£ng": {
                skills: ["L·ªõp v√† ƒê·ªëi t∆∞·ª£ng (Classes & Objects)", "K·∫ø th·ª´a (Inheritance)",
                       "ƒêa h√¨nh (Polymorphism)", "ƒê√≥ng g√≥i (Encapsulation)"],
                icon: "üéØ"
            }
        };
        
        // Mapping t√™n m√¥n h·ªçc gi·ªØa API chi ti·∫øt v√† API danh s√°ch
        const COURSE_NAME_MAPPING = {
            "C·∫•u Tr√∫c D·ªØ Li·ªáu": "C·∫•u tr√∫c D·ªØ Li·ªáu v√† Gi·∫£i Thu·∫≠t",
            "K·ªπ Thu·∫≠t L·∫≠p Tr√¨nh": "Kƒ© Thu·∫≠t L·∫≠p Tr√¨nh"
        };

        function normalizeClass(code) {
            if (!code) return '';
            return String(code).replace(/\s+/g, '').toUpperCase();
        }

        // Initialize view mode and toggle function
        window.viewMode = 'table';  // Default view mode
        
        // Toggle between table and grid views
        function toggleViewMode() {
            console.log('=== toggleViewMode called ===');
            window.viewMode = window.viewMode === 'table' ? 'grid' : 'table';
            localStorage.setItem('viewMode', window.viewMode); // L∆∞u l·∫°i ch·∫ø ƒë·ªô xem
            const btn = document.getElementById('toggleViewBtn');
            btn.textContent = window.viewMode === 'table' ? 'üóíÔ∏è Ch·∫ø ƒë·ªô: Danh s√°ch' : 'üî≤ Ch·∫ø ƒë·ªô: L∆∞·ªõi';
            // Re-render students
            if (allStudents && allStudents.length > 0) {
                console.log('Re-rendering with lastRenderedStudents:', lastRenderedStudents ? lastRenderedStudents.length : 'null');
                renderStudentList(lastRenderedStudents || allStudents);
            }
        }

        // Search students by name or student ID
        function searchStudents() {
            const searchTerm = (document.getElementById('studentSearchInput').value || '').trim().toLowerCase();
            
            if (!allStudents || allStudents.length === 0) {
                return;
            }
            
            if (!searchTerm) {
                // N·∫øu kh√¥ng c√≥ t·ª´ kh√≥a, hi·ªÉn th·ªã t·∫•t c·∫£ sinh vi√™n
                renderStudentList(allStudents);
                return;
            }
            
            // L·ªçc sinh vi√™n theo t√™n ho·∫∑c MSSV
            const filteredStudents = allStudents.filter(student => {
                const name = (student.name || '').toLowerCase();
                const studentId = String(student.student_id || '').toLowerCase();
                const studentClass = (student.class || student.csv_data?.class || '').toLowerCase();
                
                return name.includes(searchTerm) || 
                       studentId.includes(searchTerm) ||
                       studentClass.includes(searchTerm);
            });
            
            renderStudentList(filteredStudents);
            
            // Scroll xu·ªëng danh s√°ch
            setTimeout(() => {
                const studentsList = document.getElementById('studentsList');
                if (studentsList) {
                    studentsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        // Search by class using the input field (calls API)
        async function searchByClass() {
            const raw = document.getElementById('classSearchInput').value || '';
            const cls = normalizeClass(raw);
            if (!cls) {
                alert('Vui l√≤ng nh·∫≠p m√£ l·ªõp h·ª£p l·ªá.');
                return;
            }
            // Select the class in the dropdown too
            const select = document.getElementById('classFilter');
            select.value = cls;
            // Use existing filterByClass logic (it will fetch by class)
            await filterByClass();
        }

        // Toggle Save Menu
        function toggleSaveMenu() {
            const menu = document.getElementById('saveMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.querySelector('.save-dropdown');
            const menu = document.getElementById('saveMenu');
            if (dropdown && menu && !dropdown.contains(e.target)) {
                menu.style.display = 'none';
            }
        });
        
        // Save all data to Supabase
        async function saveAllToSupabase() {
            toggleSaveMenu();
            
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = '‚è≥ ƒêang l∆∞u...';
            saveBtn.disabled = true;
            
            try {
                // G·ªçi API ƒë·ªÉ sync l√™n Supabase
                const response = await fetch('/api/sync-supabase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng l√™n Supabase!\n\n` +
                          `üìä Th·ªëng k√™:\n` +
                          `‚Ä¢ Sinh vi√™n: ${result.stats?.students || 0}\n` +
                          `‚Ä¢ ƒêi·ªÉm m√¥n h·ªçc: ${result.stats?.course_scores || 0}\n` +
                          `‚Ä¢ ƒê√°nh gi√° k·ªπ nƒÉng: ${result.stats?.skill_evaluations || 0}\n` +
                          `‚Ä¢ Ph√¢n lo·∫°i: ${result.stats?.classifications || 0}\n` +
                          `‚Ä¢ ƒêi·ªÉm t√≠ch h·ª£p: ${result.stats?.integrated_scores || 0}\n` +
                          `‚Ä¢ Chi ti·∫øt b√†i t·∫≠p: ${result.stats?.exercise_details || 0}`);
                } else {
                    alert('‚ùå L·ªói khi l∆∞u: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
            } finally {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        // Download currently displayed students grouped by class as CSV
        // Download current filtered list as CSV
        function downloadCurrentList() {
            const students = lastRenderedStudents && lastRenderedStudents.length ? lastRenderedStudents : allStudents;
            if (!students || students.length === 0) {
                alert('Kh√¥ng c√≥ sinh vi√™n ƒë·ªÉ l∆∞u.');
                return;
            }

            // Build CSV content with BOM for UTF-8
            const lines = [];
            const header = ['STT','MSSV','Ho Ten','Lop','Khoa','Diem TB','Thoi Gian TB (h)','Tham Gia (%)','Nop Muon','Muc Do','Bat Thuong'];
            lines.push(header.join(','));

            students.forEach((s, index) => {
                // T√≠nh ƒëi·ªÉm v√† th·ªùi gian trung b√¨nh
                let totalScore = 0;
                let totalTime = 0;
                let courseCount = 0;
                
                if (s.courses) {
                    Object.values(s.courses).forEach(course => {
                        if (course.score !== undefined) {
                            totalScore += course.score;
                            courseCount++;
                        }
                        if (course.time_minutes !== undefined) {
                            totalTime += course.time_minutes;
                        }
                    });
                }
                
                const avgScore = courseCount > 0 ? (totalScore / courseCount) : "N/A";
                const avgTimeHours = courseCount > 0 ? (totalTime / courseCount / 60).toFixed(1) : "0";
                const attendance = s.csv_data?.attendance_rate ? (parseFloat(s.csv_data.attendance_rate) * 100).toFixed(0) : "N/A";
                const lateSubmissions = s.csv_data?.late_submissions || 0;
                const cls = s.class || s.csv_data?.class || '';
                
                // ∆Øu ti√™n final_level t·ª´ server
                const level = s.final_level || calculateStudentLevel(s);
                const levelDisplay = {
                    'Xuat sac': 'Xuat sac',
                    'Kha': 'Kha',
                    'Trung binh': 'Trung binh',
                    'Yeu': 'Yeu'
                }[level] || level;
                
                const anomaly = s.anomaly_detected ? 'Co' : 'Khong';
                
                const row = [
                    index + 1,
                    '"' + (s.student_id || '') + '"',
                    '"' + ((s.name||'').replace(/"/g,'""')) + '"',
                    '"' + cls + '"',
                    '"' + (s.Khoa || s.khoa || s.csv_data?.Khoa || 'Khoa Cong Nghe Thong Tin') + '"',
                    avgScore,
                    avgTimeHours,
                    attendance,
                    lateSubmissions,
                    '"' + levelDisplay + '"',
                    '"' + anomaly + '"'
                ];
                lines.push(row.join(','));
            });
            
            // Add summary
            const summary = {
                'Xuat sac': 0,
                'Kha': 0,
                'Trung binh': 0,
                'Yeu': 0
            };
            let anomalyCount = 0;
            
            students.forEach(s => {
                const level = s.final_level || calculateStudentLevel(s);
                if (summary[level] !== undefined) {
                    summary[level]++;
                }
                if (s.anomaly_detected) {
                    anomalyCount++;
                }
            });
            
            lines.push('');
            lines.push(`"TONG KET:","Tong: ${students.length}","Xuat sac: ${summary['Xuat sac']}","Kha: ${summary['Kha']}","Trung binh: ${summary['Trung binh']}","Yeu: ${summary['Yeu']}","Bat thuong: ${anomalyCount}"`);

            // Add UTF-8 BOM for Excel compatibility
            const BOM = '\uFEFF';
            const csvContent = BOM + lines.join('\r\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            a.download = `danh_sach_sinh_vien_${now.toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            
            alert(`ƒê√£ l∆∞u ${students.length} sinh vi√™n!`);
        }

        function downloadByClass() {
            const students = lastRenderedStudents && lastRenderedStudents.length ? lastRenderedStudents : allStudents;
            if (!students || students.length === 0) {
                alert('Kh√¥ng c√≥ sinh vi√™n ƒë·ªÉ l∆∞u.');
                return;
            }

            // Group by normalized class
            const groups = {};
            students.forEach(s => {
                const clsRaw = s.class || s.csv_data?.class || '';
                const cls = normalizeClass(clsRaw) || 'UNKNOWN';
                if (!groups[cls]) groups[cls] = [];
                groups[cls].push(s);
            });

            // Build CSV content with BOM for UTF-8
            const lines = [];
            const header = ['Lop','MSSV','Ho Ten','Khoa','Diem TB','Thoi Gian TB (phut)','Tham Gia (%)','Nop Muon','Muc Do','Bat Thuong'];
            lines.push(header.join(','));

            Object.keys(groups).sort().forEach(cls => {
                // Add class header
                lines.push(`\n"=== ${cls} (${groups[cls].length} sinh vien) ==="`);
                
                groups[cls].forEach(s => {
                    // T√≠nh ƒëi·ªÉm v√† th·ªùi gian trung b√¨nh
                    let totalScore = 0;
                    let totalTime = 0;
                    let courseCount = 0;
                    
                    if (s.courses) {
                        Object.values(s.courses).forEach(course => {
                            if (course.score !== undefined) {
                                totalScore += course.score;
                                courseCount++;
                            }
                            if (course.time_minutes !== undefined) {
                                totalTime += course.time_minutes;
                            }
                        });
                    }
                    
                    const avgScore = courseCount > 0 ? (totalScore / courseCount) : "N/A";
                    const avgTime = courseCount > 0 ? Math.round(totalTime / courseCount) : 0;
                    const attendance = s.csv_data?.attendance_rate ? (parseFloat(s.csv_data.attendance_rate) * 100).toFixed(0) : "N/A";
                    const lateSubmissions = s.csv_data?.late_submissions || 0;
                    
                    // ∆Øu ti√™n final_level t·ª´ server
                    const level = s.final_level || calculateStudentLevel(s);
                    const levelDisplay = {
                        'Xuat sac': 'Xuat sac',
                        'Kha': 'Kha',
                        'Trung binh': 'Trung binh',
                        'Yeu': 'Yeu'
                    }[level] || level;
                    
                    const anomaly = s.anomaly_detected ? 'Co' : 'Khong';
                    
                    const row = [
                        '"' + cls + '"',
                        '"' + (s.student_id || '') + '"',
                        '"' + ((s.name||'').replace(/"/g,'""')) + '"',
                        '"' + (s.Khoa || s.khoa || s.csv_data?.Khoa || 'Khoa Cong Nghe Thong Tin') + '"',
                        avgScore,
                        avgTime,
                        attendance,
                        lateSubmissions,
                        '"' + levelDisplay + '"',
                        '"' + anomaly + '"'
                    ];
                    lines.push(row.join(','));
                });
                
                // Th·ªëng k√™ l·ªõp
                const classStats = {
                    'Xuat sac': 0,
                    'Kha': 0,
                    'Trung binh': 0,
                    'Yeu': 0
                };
                let anomalyCount = 0;
                
                groups[cls].forEach(s => {
                    const level = s.final_level || calculateStudentLevel(s);
                    if (classStats[level] !== undefined) {
                        classStats[level]++;
                    }
                    if (s.anomaly_detected) {
                        anomalyCount++;
                    }
                });
                
                lines.push(`\n"Thong ke ${cls}:","Xuat sac: ${classStats['Xuat sac']}","Kha: ${classStats['Kha']}","Trung binh: ${classStats['Trung binh']}","Yeu: ${classStats['Yeu']}","Bat thuong: ${anomalyCount}"`);
                lines.push(''); // blank line between classes
            });

            // Add UTF-8 BOM for Excel compatibility
            const BOM = '\uFEFF';
            const csvContent = BOM + lines.join('\r\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            a.download = `danh_sach_sinh_vien_theo_lop_${now.toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            
            alert(`ƒê√£ l∆∞u ${students.length} sinh vi√™n t·ª´ ${Object.keys(groups).length} l·ªõp!`);
        }

        // L∆∞u danh s√°ch sinh vi√™n theo m√¥n h·ªçc
        function downloadByCourse() {
            const students = lastRenderedStudents && lastRenderedStudents.length ? lastRenderedStudents : allStudents;
            if (!students || students.length === 0) {
                alert('Kh√¥ng c√≥ sinh vi√™n ƒë·ªÉ l∆∞u.');
                return;
            }

            // Group by course
            const groups = {};
            Object.keys(COURSES).forEach(courseName => {
                groups[courseName] = students.filter(s => s.courses && s.courses[courseName]);
            });

            // Build CSV content with BOM for UTF-8
            const lines = [];
            const header = ['Mon Hoc','MSSV','Ho Ten','Lop','Diem','Thoi Gian (phut)','Muc Do','Bat Thuong'];
            lines.push(header.join(','));

            Object.keys(groups).sort().forEach(courseName => {
                if (groups[courseName].length === 0) return;
                
                // Add course header
                const courseInfo = COURSES[courseName];
                lines.push(`\n"=== ${courseName} (${groups[courseName].length} sinh vien) ==="`);
                
                groups[courseName].forEach(s => {
                    const courseData = s.courses[courseName];
                    const cls = s.class || s.csv_data?.class || '';
                    const level = s.final_level || calculateStudentLevel(s);
                    const levelDisplay = {
                        'Xuat sac': 'Xuat sac',
                        'Kha': 'Kha',
                        'Trung binh': 'Trung binh',
                        'Yeu': 'Yeu'
                    }[level] || level;
                    const anomaly = s.anomaly_detected ? 'Co' : 'Khong';
                    
                    const row = [
                        '"' + courseName + '"',
                        '"' + (s.student_id || '') + '"',
                        '"' + ((s.name||'').replace(/"/g,'""')) + '"',
                        '"' + cls + '"',
                        formatScore(courseData.score),
                        Math.round(courseData.time_minutes || 0),
                        '"' + levelDisplay + '"',
                        '"' + anomaly + '"'
                    ];
                    lines.push(row.join(','));
                });
                
                // Th·ªëng k√™ m√¥n h·ªçc
                const courseStats = {
                    'Xuat sac': 0,
                    'Kha': 0,
                    'Trung binh': 0,
                    'Yeu': 0
                };
                let anomalyCount = 0;
                let totalScore = 0;
                let totalTime = 0;
                
                groups[courseName].forEach(s => {
                    const level = s.final_level || calculateStudentLevel(s);
                    if (courseStats[level] !== undefined) {
                        courseStats[level]++;
                    }
                    if (s.anomaly_detected) {
                        anomalyCount++;
                    }
                    const courseData = s.courses[courseName];
                    totalScore += courseData.score || 0;
                    totalTime += courseData.time_minutes || 0;
                });
                
                const avgScore = (totalScore / groups[courseName].length).toFixed(1);
                const avgTime = Math.round(totalTime / groups[courseName].length);
                
                lines.push(`\n"Thong ke ${courseName}:","Diem TB: ${avgScore}","Thoi gian TB: ${avgTime}m","Xuat sac: ${courseStats['Xuat sac']}","Kha: ${courseStats['Kha']}","Trung binh: ${courseStats['Trung binh']}","Yeu: ${courseStats['Yeu']}","Bat thuong: ${anomalyCount}"`);
                lines.push(''); // blank line between courses
            });

            // Add UTF-8 BOM for Excel compatibility
            const BOM = '\uFEFF';
            const csvContent = BOM + lines.join('\r\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            a.download = `danh_sach_sinh_vien_theo_mon_${now.toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            
            const courseCount = Object.keys(groups).filter(c => groups[c].length > 0).length;
            alert(`ƒê√£ l∆∞u ${students.length} sinh vi√™n t·ª´ ${courseCount} m√¥n h·ªçc!`);
        }

        // T·∫£i b·∫£ng ƒëi·ªÉm chi ti·∫øt (ƒëi·ªÉm t·ª´ng m√¥n + k·ªπ nƒÉng)
        function downloadScoreReport() {
            const students = lastRenderedStudents && lastRenderedStudents.length ? lastRenderedStudents : allStudents;
            if (!students || students.length === 0) {
                alert('Kh√¥ng c√≥ sinh vi√™n ƒë·ªÉ l∆∞u.');
                return;
            }

            // Build CSV content with BOM for UTF-8
            const lines = [];
            
            // Header v·ªõi t·∫•t c·∫£ c√°c m√¥n v√† k·ªπ nƒÉng
            const header = [
                'STT', 'MSSV', 'Ho Ten', 'Lop', 'Khoa',
                'Diem TB', 'Diem Tich Hop', 'Muc Do', 'Bat Thuong',
                // ƒêi·ªÉm t·ª´ng m√¥n
                'NMLT', 'KTLT', 'CTDL', 'OOP',
                // ƒêi·ªÉm gi·ªØa k·ª≥, cu·ªëi k·ª≥, b√†i t·∫≠p
                'Giua Ky', 'Cuoi Ky', 'Bai Tap',
                // Th√¥ng tin kh√°c
                'Tham Gia (%)', 'Gio Hoc/Tuan', 'Nop Muon'
            ];
            lines.push(header.join(','));

            students.forEach((s, index) => {
                // T√≠nh ƒëi·ªÉm trung b√¨nh
                let totalScore = 0;
                let courseCount = 0;
                const courseScores = {};
                
                const courseNames = ['Nh·∫≠p M√¥n L·∫≠p Tr√¨nh', 'Kƒ© Thu·∫≠t L·∫≠p Tr√¨nh', 'C·∫•u tr√∫c D·ªØ Li·ªáu v√† Gi·∫£i Thu·∫≠t', 'L·∫≠p Tr√¨nh H∆∞·ªõng ƒê·ªëi T∆∞·ª£ng'];
                const courseKeys = ['NMLT', 'KTLT', 'CTDL', 'OOP'];
                
                courseNames.forEach((name, i) => {
                    if (s.courses && s.courses[name]) {
                        courseScores[courseKeys[i]] = s.courses[name].score || 0;
                        totalScore += s.courses[name].score || 0;
                        courseCount++;
                    } else {
                        courseScores[courseKeys[i]] = 'N/A';
                    }
                });
                
                const avgScore = courseCount > 0 ? (totalScore / courseCount).toFixed(1) : 'N/A';
                const integratedScore = s.integrated_score || avgScore;
                
                const cls = s.class || s.csv_data?.class || '';
                const khoa = s.Khoa || s.csv_data?.Khoa || '';
                const level = s.final_level || calculateStudentLevel(s);
                const anomaly = s.anomaly_detected ? 'Co' : 'Khong';
                
                const csvData = s.csv_data || {};
                const attendance = csvData.attendance_rate ? (parseFloat(csvData.attendance_rate) * 100).toFixed(0) : 'N/A';
                const studyHours = csvData.study_hours_per_week || 'N/A';
                const lateSubmissions = csvData.late_submissions || 0;
                const midterm = csvData.midterm_score || 'N/A';
                const final = csvData.final_score || 'N/A';
                const homework = csvData.homework_score || 'N/A';
                
                const row = [
                    index + 1,
                    '"' + (s.student_id || '') + '"',
                    '"' + ((s.name||'').replace(/"/g,'""')) + '"',
                    '"' + cls + '"',
                    '"' + khoa + '"',
                    avgScore,
                    integratedScore,
                    '"' + level + '"',
                    '"' + anomaly + '"',
                    courseScores['NMLT'],
                    courseScores['KTLT'],
                    courseScores['CTDL'],
                    courseScores['OOP'],
                    midterm,
                    final,
                    homework,
                    attendance,
                    studyHours,
                    lateSubmissions
                ];
                lines.push(row.join(','));
            });

            // Th√™m th·ªëng k√™ cu·ªëi file
            lines.push('');
            lines.push('"=== THONG KE TONG HOP ==="');
            
            // T√≠nh th·ªëng k√™
            const stats = { 'Xuat sac': 0, 'Kha': 0, 'Trung binh': 0, 'Yeu': 0 };
            let anomalyCount = 0;
            let totalAvg = 0;
            
            students.forEach(s => {
                const level = s.final_level || calculateStudentLevel(s);
                if (stats[level] !== undefined) stats[level]++;
                if (s.anomaly_detected) anomalyCount++;
                
                let sum = 0, count = 0;
                if (s.courses) {
                    Object.values(s.courses).forEach(c => {
                        if (c.score) { sum += c.score; count++; }
                    });
                }
                if (count > 0) totalAvg += sum / count;
            });
            
            const avgAll = (totalAvg / students.length).toFixed(2);
            
            lines.push(`"Tong sinh vien:",${students.length}`);
            lines.push(`"Diem trung binh:",${avgAll}`);
            lines.push(`"Xuat sac:",${stats['Xuat sac']}`);
            lines.push(`"Kha:",${stats['Kha']}`);
            lines.push(`"Trung binh:",${stats['Trung binh']}`);
            lines.push(`"Yeu:",${stats['Yeu']}`);
            lines.push(`"Bat thuong:",${anomalyCount}`);

            // Add UTF-8 BOM for Excel compatibility
            const BOM = '\uFEFF';
            const csvContent = BOM + lines.join('\r\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            a.download = `bang_diem_chi_tiet_${now.toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            
            alert(`ƒê√£ t·∫£i b·∫£ng ƒëi·ªÉm chi ti·∫øt c·ªßa ${students.length} sinh vi√™n!`);
        }

        function updateClassFilter() {
            const select = document.getElementById('classFilter');
            const currentValue = select.value;
            
            // C·∫≠p nh·∫≠t danh s√°ch l·ªõp
            uniqueClasses.clear();
            allStudents.forEach(student => {
                const classValue = student.class || student.csv_data?.class;
                const norm = normalizeClass(classValue);
                if (norm) uniqueClasses.add(norm);
            });
            
            // T·∫°o options
            const options = ['<option value="">üè´ T·∫•t c·∫£ l·ªõp</option>'];
            Array.from(uniqueClasses).sort().forEach(cls => {
                options.push(`<option value="${cls}" ${cls === currentValue ? 'selected' : ''}>${cls}</option>`);
            });
            
            select.innerHTML = options.join('');
        }

        async function filterByClass() {
            const rawClassValue = document.getElementById('classFilter').value;
            const classValue = normalizeClass(rawClassValue);
            currentClass = classValue;
            
            try {
                const [studentsRes, statsRes] = await Promise.all([
                    fetch(`${API_BASE}/api/students${classValue ? `?class=${encodeURIComponent(classValue)}` : ''}`),
                        fetch(`${API_BASE}/api/statistics${classValue ? `?class=${encodeURIComponent(classValue)}` : ''}`)
                ]);

                const studentsData = await studentsRes.json();
                const statsData = await statsRes.json();

                // C·∫≠p nh·∫≠t d·ªØ li·ªáu
                allStudents = studentsData.students || [];
                window.studentsData = allStudents; // L∆∞u v√†o global ƒë·ªÉ d√πng cho updateScoreTable
                skillEvaluations = studentsData.skill_evaluations || {};
                
                // Nh√≥m theo m√¥n h·ªçc
                Object.keys(COURSES).forEach(courseName => {
                    coursesData[courseName] = allStudents.filter(s => 
                        s.courses && s.courses[courseName]
                    );
                });

                // C·∫≠p nh·∫≠t giao di·ªán
                displayStatistics(statsData);
                drawCourseScoreChart(allStudents, skillEvaluations);
                drawSkillPassChart(allStudents, skillEvaluations);
                drawTimeChart(allStudents);
                // Hi·ªÉn th·ªã danh s√°ch sinh vi√™n ban ƒë·∫ßu (kh√¥ng l·ªçc)
                renderStudentList(allStudents);
                
                // T·ª± ƒë·ªông scroll xu·ªëng ph·∫ßn danh s√°ch sinh vi√™n
                setTimeout(() => {
                    const studentsList = document.getElementById('studentsList');
                    if (studentsList) {
                        studentsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
                
                if (currentCourse) {
                    displayCourseContent(currentCourse);
                }
            } catch (error) {
                console.error('Error filtering by class:', error);
                alert('L·ªói khi l·ªçc theo l·ªõp: ' + error.message);
            }
        }

        // L·ªçc sinh vi√™n theo m√¥n h·ªçc
        function filterByCourse() {
            const courseFilter = document.getElementById('courseFilter');
            const selectedCourse = courseFilter.value;
            
            console.log('Filtering by course:', selectedCourse);
            
            if (!selectedCourse) {
                // Hi·ªÉn th·ªã t·∫•t c·∫£ sinh vi√™n
                renderStudentList(allStudents);
                return;
            }
            
            // L·ªçc sinh vi√™n c√≥ h·ªçc m√¥n n√†y
            const filteredStudents = allStudents.filter(student => {
                return student.courses && student.courses[selectedCourse];
            });
            
            console.log(`Found ${filteredStudents.length} students for course ${selectedCourse}`);
            
            // Hi·ªÉn th·ªã danh s√°ch ƒë√£ l·ªçc
            renderStudentList(filteredStudents);
            
            // T·ª± ƒë·ªông scroll xu·ªëng ph·∫ßn danh s√°ch sinh vi√™n
            setTimeout(() => {
                const studentsList = document.getElementById('studentsList');
                if (studentsList) {
                    studentsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        // C·∫≠p nh·∫≠t dropdown m√¥n h·ªçc
        function updateCourseFilter() {
            const courseFilter = document.getElementById('courseFilter');
            if (!courseFilter) return;
            
            const currentValue = courseFilter.value;
            
            // T·∫°o options
            let options = '<option value="">üìö T·∫•t c·∫£ m√¥n h·ªçc</option>';
            
            Object.keys(COURSES).forEach(courseName => {
                const courseInfo = COURSES[courseName];
                const studentCount = allStudents.filter(s => s.courses && s.courses[courseName]).length;
                options += `<option value="${courseName}">${courseInfo.icon} ${courseName} (${studentCount})</option>`;
            });
            
            courseFilter.innerHTML = options;
            
            // Gi·ªØ l·∫°i gi√° tr·ªã ƒë√£ ch·ªçn n·∫øu c√≥
            if (currentValue && Object.keys(COURSES).includes(currentValue)) {
                courseFilter.value = currentValue;
            }
        }

        async function classifyStudents() {
            // Ensure we have the latest students loaded so we can classify ALL of them
            try {
                await loadStudents();
            } catch (e) {
                console.warn('Could not refresh students before classify:', e);
            }

            // Determine number of students to classify: use current loaded list (allStudents)
            const totalToClassify = (allStudents && allStudents.length) ? allStudents.length : (parseInt(document.getElementById('numStudents').value) || 50);
            const statusEl = document.getElementById('status');
            statusEl.textContent = `‚è≥ ƒêang ph√¢n lo·∫°i ${totalToClassify} sinh vi√™n...`;
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';

            try {
                const response = await fetch(`${API_BASE}/api/classify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ n_students: totalToClassify })
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.textContent = `‚úÖ ƒê√£ ph√¢n lo·∫°i ${data.statistics.total || totalToClassify} sinh vi√™n`;
                    statusEl.style.background = '#d4edda';
                    statusEl.style.color = '#155724';
                    // Refresh data after classification
                    await loadStudents();
                } else {
                    statusEl.textContent = `‚ùå L·ªói: ${data.error}`;
                    statusEl.style.background = '#f8d7da';
                    statusEl.style.color = '#721c24';
                }
            } catch (error) {
                statusEl.textContent = `‚ùå L·ªói: ${error.message}`;
                statusEl.style.background = '#f8d7da';
                statusEl.style.color = '#721c24';
            }
        }

        async function loadStudents() {
            try {
                const [studentsRes, statsRes] = await Promise.all([
                    fetch(`${API_BASE}/api/students`),
                    fetch(`${API_BASE}/api/statistics`)
                ]);

                const studentsData = await studentsRes.json();
                const statsData = await statsRes.json();

                allStudents = studentsData.students || [];
                window.studentsData = allStudents; // L∆∞u v√†o global ƒë·ªÉ d√πng cho updateScoreTable
                skillEvaluations = studentsData.skill_evaluations || {};
                
                // Debug: ki·ªÉm tra anomaly_detected
                const anomalyStudents = allStudents.filter(s => s.anomaly_detected);
                console.log('Total students:', allStudents.length);
                console.log('Anomaly students:', anomalyStudents.length);
                
                // C·∫≠p nh·∫≠t danh s√°ch l·ªõp v√† m√¥n h·ªçc
                updateClassFilter();
                updateCourseFilter();

                // Hi·ªÉn th·ªã th·ªëng k√™ v√† bi·ªÉu ƒë·ªì
                displayStatistics(statsData);
                drawCourseScoreChart(allStudents, skillEvaluations);
                drawSkillPassChart(allStudents, skillEvaluations);
                drawTimeChart(allStudents);
                
                // Hi·ªÉn th·ªã danh s√°ch sinh vi√™n
                renderStudentList(allStudents);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('courseContent').innerHTML = 
                    '<div class="loading">‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
            }
        }

        let levelChart = null;
        let courseScoreChart = null;
        let skillPassChart = null;
        let timeChart = null;

        // Hi·ªán tr·∫°ng l·ªçc theo level tr√™n client
        let currentLevelFilter = '';

        // L·∫•y level n·ªôi b·ªô c·ªßa 1 student (chu·∫©n h√≥a c√°c tr∆∞·ªùng kh√°c nhau)
        function studentLevelOf(s) {
            if (!s) return null;
            const candidates = [s.final_level, s.level_prediction, s.predicted_level, s.base_level, s.predictedLevel];
            for (let v of candidates) {
                if (!v) continue;
                const sNorm = String(v).toLowerCase().replace(/\s+/g, '');
                if (sNorm.startsWith('xuatsac') || sNorm === 'xuatsac' || sNorm === 'xuatsach' || sNorm === 'gioi') return 'Xuat sac';
                if (sNorm.startsWith('kha')) return 'Kha';
                if (sNorm.startsWith('trung') || sNorm.startsWith('trungbinh')) return 'Trung binh';
                if (sNorm.startsWith('yeu') || sNorm.startsWith('kem')) return 'Yeu';
            }
            return null;
        }

        // √Åp d·ª•ng l·ªçc theo level: truy·ªÅn key n·ªôi b·ªô ('Xuat sac','Kha','Trung binh','Yeu') ho·∫∑c '' ƒë·ªÉ b·ªè l·ªçc
        function applyLevelFilter(levelKey) {
            console.log('=== applyLevelFilter called ===');
            console.log('Level key:', levelKey);
            
            // Toggle: n·∫øu click l·∫°i c√πng m·ª©c th√¨ b·ªè l·ªçc
            if (currentLevelFilter === levelKey) levelKey = '';
            currentLevelFilter = levelKey;

            // L·ªçc danh s√°ch sinh vi√™n hi·ªán t·∫°i tr√™n client - D√ôNG calculateStudentLevel() thay v√¨ studentLevelOf()
            let filtered;
            if (currentLevelFilter === 'anomaly') {
                filtered = allStudents.filter(s => s.anomaly_detected);
            } else if (currentLevelFilter) {
                filtered = allStudents.filter(s => (s.final_level || calculateStudentLevel(s)) === currentLevelFilter);
            } else {
                filtered = allStudents.slice();
            }

            console.log('applyLevelFilter - Filtered count:', filtered.length);
            
            // Hi·ªÉn th·ªã danh s√°ch sinh vi√™n ƒë∆∞·ª£c l·ªçc
            renderStudentList(filtered);

            // C·∫≠p nh·∫≠t c√°c d·ªØ li·ªáu ph·ª• thu·ªôc (bi·ªÉu ƒë·ªì, n·ªôi dung m√¥n h·ªçc)
            Object.keys(COURSES).forEach(courseName => {
                coursesData[courseName] = filtered.filter(s => s.courses && s.courses[courseName]);
            });

            // V·∫Ω l·∫°i c√°c bi·ªÉu ƒë·ªì theo danh s√°ch ƒë√£ l·ªçc
            drawCourseScoreChart(filtered, skillEvaluations);
            drawSkillPassChart(filtered, skillEvaluations);
            drawTimeChart(filtered);

            // N·∫øu ƒëang hi·ªÉn th·ªã n·ªôi dung 1 m√¥n, c·∫≠p nh·∫≠t l·∫°i
            if (currentCourse) displayCourseContent(currentCourse);

            // N·∫øu c√≥ ph·∫ßn hi·ªÉn th·ªã danh s√°ch sinh vi√™n, cu·ªôn t·ªõi ƒë√≥ (n·∫øu c√≥)
            const listEl = document.getElementById('studentsList') || document.getElementById('courseContent');
            if (listEl) listEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Expose to global scope for inline onclick handlers
        window.applyLevelFilter = applyLevelFilter;
        window.studentLevelOf = studentLevelOf;

        // Event delegation ƒë√£ b·ªã v√¥ hi·ªáu h√≥a v√¨ ch√∫ng ta d√πng onclick tr·ª±c ti·∫øp trong HTML
        // document.addEventListener('click', function (e) {
        //     const card = e.target.closest && e.target.closest('#statsContainer .stat-card');
        //     if (!card) return;
        //     const lvl = card.getAttribute('data-level') || '';
        //     applyLevelFilter(lvl === 'all' ? '' : lvl);
        // });

        function displayStatistics(stats) {
            const container = document.getElementById('statsContainer');
            const levelNames = {
                'Xuat sac': 'Xu·∫•t s·∫Øc',
                'Kha': 'Kh√°',
                'Trung binh': 'Trung b√¨nh',
                'Yeu': 'Y·∫øu'
            };

            // T√≠nh l·∫°i th·ªëng k√™ d·ª±a tr√™n calculateStudentLevel()
            const recalculatedCounts = {
                'Xuat sac': 0,
                'Kha': 0,
                'Trung binh': 0,
                'Yeu': 0
            };
            
            let anomalyCount = 0;
            
            // H√†m ki·ªÉm tra b·∫•t th∆∞·ªùng (gi·ªëng trang chi ti·∫øt)
            function isAnomaly(student) {
                // N·∫øu server ƒë√£ ƒë√°nh d·∫•u
                if (student.anomaly_detected) return true;
                
                // T√≠nh to√°n d·ª±a tr√™n ƒëi·ªÉm v√† th·ªùi gian
                const courses = student.courses || {};
                const courseKeys = Object.keys(courses);
                if (courseKeys.length === 0) return false;
                
                const avgScore = courseKeys.reduce((sum, k) => sum + (courses[k].score || 0), 0) / courseKeys.length;
                const avgTime = courseKeys.reduce((sum, k) => sum + (courses[k].time_minutes || 0), 0) / courseKeys.length;
                const timeInHours = avgTime / 60;
                
                // ƒêi·ªÉm cao b·∫•t th∆∞·ªùng v·ªõi th·ªùi gian th·∫•p
                if (avgScore >= 9.5 && timeInHours < 4) return true;
                if (avgScore >= 9.0 && timeInHours < 2) return true;
                if (avgScore >= 8.5 && timeInHours < 1.5) return true;
                
                return false;
            }
            
            if (allStudents && allStudents.length > 0) {
                allStudents.forEach(student => {
                    const level = student.final_level || calculateStudentLevel(student);
                    if (recalculatedCounts[level] !== undefined) {
                        recalculatedCounts[level]++;
                    }
                    if (isAnomaly(student)) {
                        anomalyCount++;
                    }
                });
            }

            container.innerHTML = `
                <div class="stat-card" data-level="all" onclick="filterStudentsByLevel('all')" style="cursor:pointer">
                    <h3>üìä T·ªïng S·ªë</h3>
                    <div class="number" style="color: #667eea;">${allStudents?.length || 0}</div>
                    <p>Sinh vi√™n</p>
                </div>
                ${Object.entries(recalculatedCounts).map(([level, count]) => `
                    <div class="stat-card ${level.toLowerCase().replace(' ', '-')}" data-level="${level}" onclick="filterStudentsByLevel('${level}')" style="cursor:pointer">
                        <h3>${levelNames[level] || level}</h3>
                        <div class="number">${count}</div>
                        <p>Sinh vi√™n</p>
                    </div>
                `).join('')}
                <div class="stat-card" data-level="anomaly" onclick="filterStudentsByLevel('anomaly')" style="cursor:pointer;border-top: 6px solid #f44336;">
                    <h3>‚ö†Ô∏è B·∫•t Th∆∞·ªùng</h3>
                    <div class="number" style="color: #f44336;">${anomalyCount}</div>
                    <p>Tr∆∞·ªùng h·ª£p</p>
                </div>
            `;

            // V·∫Ω bi·ªÉu ƒë·ªì ph√¢n b·ªë m·ª©c ƒë·ªô v·ªõi d·ªØ li·ªáu m·ªõi
            const recalculatedStats = {
                total_students: allStudents?.length || 0,
                level_counts: recalculatedCounts,
                anomaly_count: anomalyCount
            };
            drawLevelChart(recalculatedStats);

        }

        // H√†m l·ªçc sinh vi√™n theo level
        function filterStudentsByLevel(level) {
            console.log('=== filterStudentsByLevel called ===');
            console.log('Filter level:', level);
            
            if (!allStudents || allStudents.length === 0) {
                console.log('No students available');
                return;
            }
            
            let filteredStudents = [];
            
            if (level === 'all') {
                // Hi·ªÉn th·ªã t·∫•t c·∫£ sinh vi√™n
                filteredStudents = allStudents;
            } else if (level === 'anomaly') {
                // Hi·ªÉn th·ªã sinh vi√™n b·∫•t th∆∞·ªùng (d√πng c√πng logic v·ªõi th·ªëng k√™)
                filteredStudents = allStudents.filter(s => {
                    if (s.anomaly_detected) return true;
                    
                    const courses = s.courses || {};
                    const courseKeys = Object.keys(courses);
                    if (courseKeys.length === 0) return false;
                    
                    const avgScore = courseKeys.reduce((sum, k) => sum + (courses[k].score || 0), 0) / courseKeys.length;
                    const avgTime = courseKeys.reduce((sum, k) => sum + (courses[k].time_minutes || 0), 0) / courseKeys.length;
                    const timeInHours = avgTime / 60;
                    
                    if (avgScore >= 9.5 && timeInHours < 4) return true;
                    if (avgScore >= 9.0 && timeInHours < 2) return true;
                    if (avgScore >= 8.5 && timeInHours < 1.5) return true;
                    
                    return false;
                });
            } else {
                // L·ªçc theo level c·ª• th·ªÉ
                filteredStudents = allStudents.filter(s => {
                    const studentLevel = s.final_level || calculateStudentLevel(s);
                    const match = studentLevel === level;
                    if (!match && level === 'Yeu') {
                        console.log('Student:', s.name, '| Level:', studentLevel, '| Expected:', level, '| Match:', match);
                    }
                    return match;
                });
            }
            
            console.log('Total students:', allStudents.length);
            console.log('Filtered students count:', filteredStudents.length);
            
            // Render l·∫°i danh s√°ch sinh vi√™n ƒë√£ l·ªçc
            renderStudentList(filteredStudents);
            
            // T·ª± ƒë·ªông scroll xu·ªëng ph·∫ßn danh s√°ch sinh vi√™n
            setTimeout(() => {
                const studentsList = document.getElementById('studentsList');
                if (studentsList) {
                    studentsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        // Render danh s√°ch sinh vi√™n (b·∫£ng) v√†o #studentsList
        function renderStudentList(students) {
            console.log('=== renderStudentList called ===');
            console.log('Students to render:', students ? students.length : 0);
            
            const container = document.getElementById('studentsList');
            if (!container) {
                console.log('Container not found!');
                return;
            }
            // remember last rendered for download/toggle
            lastRenderedStudents = students || [];
            if (!students || students.length === 0) {
                container.innerHTML = `
                    <div style="background:white;padding:32px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08);text-align:center">
                        <div style="font-size:48px;margin-bottom:16px">üìö</div>
                        <h3 style="margin:0 0 8px 0;color:#374151;font-size:20px">Kh√¥ng c√≥ sinh vi√™n</h3>
                        <p style="color:#6b7280;margin:0">H√£y th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c th√™m sinh vi√™n m·ªõi</p>
                    </div>`;
                return;
            }
            if (viewMode === 'table') {
                const rows = students.map(s => {
                    const lvl = s.final_level || calculateStudentLevel(s); // ∆Øu ti√™n final_level t·ª´ server
                    const cls = s.class || s.csv_data?.class || '';
                    const khoa = s.Khoa || s.khoa || s.csv_data?.Khoa || 'Khoa C√¥ng Ngh·ªá Th√¥ng Tin';
                    
                    // T√≠nh ƒëi·ªÉm v√† th·ªùi gian trung b√¨nh
                    let totalScore = 0;
                    let totalTime = 0;
                    let courseCount = 0;
                    Object.keys(COURSES).forEach(courseName => {
                        if (s.courses && s.courses[courseName]) {
                            totalScore += s.courses[courseName].score || 0;
                            totalTime += s.courses[courseName].time_minutes || 0;
                            courseCount++;
                        }
                    });
                    const avgScore = courseCount > 0 ? (totalScore / courseCount) : "N/A";
                    // D√πng t·ªïng th·ªùi gian ƒë·ªÉ ƒë·ªìng nh·∫•t v·ªõi modal chi ti·∫øt
                    const timeInHours = totalTime / 60;

                    // Ki·ªÉm tra sinh vi√™n thi·∫øu d·ªØ li·ªáu
                    const isInsufficientData = s.insufficient_data || lvl === 'Chua du du lieu';
                    
                    // X√°c ƒë·ªãnh m√†u n·ªÅn d·ª±a tr√™n level
                    const levelColorClass = isInsufficientData ? 'background:rgba(244,67,54,0.15)' : {
                        'Xuat sac': 'background:rgba(76,175,80,0.1)',
                        'Kha': 'background:rgba(33,150,243,0.1)',
                        'Trung binh': 'background:rgba(255,152,0,0.1)',
                        'Yeu': 'background:rgba(244,67,54,0.1)'
                    }[lvl] || '';

                    return `
                        <tr style="border-bottom:1px solid #eee;${levelColorClass}">
                            <td style="padding:12px;font-weight:500">${s.student_id || ''}</td>
                            <td style="padding:12px">
                                <div style="font-weight:500">${(s.name||'').replace(/</g,'&lt;')}</div>
                                <div style="font-size:12px;color:#666;margin-top:4px">
                                    ƒêi·ªÉm TB: ${isInsufficientData || avgScore === "N/A" ? '<span style="color:#dc3545;font-weight:bold">N/A</span>' : parseFloat(avgScore).toFixed(1) + '/10'} | Th·ªùi gian h·ªçc: ${isInsufficientData || totalTime === 0 ? '<span style="color:#dc3545;font-weight:bold">N/A</span>' : Math.floor(timeInHours) + 'h ' + Math.round(totalTime%60) + 'm'}
                                </div>
                            </td>
                            <td style="padding:12px">
                                <div style="font-weight:500">${cls}</div>
                                <div style="font-size:12px;color:#666;margin-top:4px">${khoa}</div>
                            </td>
                            <td style="padding:12px">
                                <span class="${isInsufficientData ? 'level-insufficient' : 'level ' + lvl.toLowerCase().replace(/\s+/g,'-')}" 
                                      style="display:inline-block;padding:6px 12px;border-radius:20px;font-size:13px;${isInsufficientData ? 'background:#dc3545;color:white;' : ''}">
                                    ${isInsufficientData ? '‚ö†Ô∏è Thi·∫øu d·ªØ li·ªáu' : lvl}
                                </span>
                            </td>
                            <td style="padding:12px">
                                <button onclick="showStudentDetail(${s.student_id})" 
                                        style="padding:6px 12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px">
                                    üìñ Chi ti·∫øt
                                </button>
                            </td>
                        </tr>`;
                }).join('');

                container.innerHTML = `
                    <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08)">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                            <h3 style="margin:0;color:#374151;font-size:18px">Danh s√°ch sinh vi√™n (${students.length})</h3>
                        </div>
                        <div style="overflow:auto;max-height:600px;border-radius:8px;border:1px solid #eee">
                            <table style="width:100%;border-collapse:collapse;font-size:14px;text-align:left;background:white">
                                <thead>
                                    <tr style="background:linear-gradient(135deg,#667eea,#764ba2)">
                                        <th style="padding:12px;color:white;font-weight:500">MSSV</th>
                                        <th style="padding:12px;color:white;font-weight:500">Th√¥ng tin sinh vi√™n</th>
                                        <th style="padding:12px;color:white;font-weight:500">L·ªõp & Khoa</th>
                                        <th style="padding:12px;color:white;font-weight:500">M·ª©c ƒë·ªô</th>
                                        <th style="padding:12px;color:white;font-weight:500">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                // Grid cards view
                const cards = students.map(s => {
                    const lvl = s.final_level || calculateStudentLevel(s); // ∆Øu ti√™n final_level t·ª´ server
                    const cls = s.class || s.csv_data?.class || '';
                    const khoa = s.Khoa || s.khoa || s.csv_data?.Khoa || 'Khoa C√¥ng Ngh·ªá Th√¥ng Tin';
                    const levelClass = lvl.toLowerCase().replace(/\s+/g,'-');
                    
                    // T√≠nh ƒëi·ªÉm v√† th·ªùi gian trung b√¨nh cho t·∫•t c·∫£ m√¥n h·ªçc
                    let totalScore = 0;
                    let totalTime = 0;
                    let courseCount = 0;
                    
                    Object.keys(COURSES).forEach(courseName => {
                        if (s.courses && s.courses[courseName]) {
                            totalScore += s.courses[courseName].score || 0;
                            totalTime += s.courses[courseName].time_minutes || 0;
                            courseCount++;
                        }
                    });
                    
                    const avgScore = courseCount > 0 ? (totalScore / courseCount) : "N/A";
                    // D√πng t·ªïng th·ªùi gian ƒë·ªÉ ƒë·ªìng nh·∫•t v·ªõi modal chi ti·∫øt
                    const timeInHours = totalTime / 60;
                    
                    return `
                        <div class="student-card">
                            <h3>${(s.name||'').replace(/</g,'&lt;')}</h3>
                            <div style="margin:12px 0;font-weight:600;color:#4B5563">MSSV: ${s.student_id || ''}</div>
                            <div style="margin:8px 0;color:#6B7280">L·ªõp: <strong>${cls}</strong></div>
                            <div style="margin:8px 0;color:#6B7280">Khoa: <strong>${khoa}</strong></div>
                            <div style="margin:8px 0;color:#6B7280">ƒêi·ªÉm TB: <strong>${parseFloat(avgScore).toFixed(1)}/10</strong></div>
                            <div style="margin:8px 0;color:#6B7280">Th·ªùi gian h·ªçc: <strong>${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m</strong></div>
                            <div style="margin:12px 0">
                                <span class="level ${levelClass}" style="display:inline-block;padding:6px 12px;border-radius:20px">${lvl}</span>
                            </div>
                            <div style="margin-top:16px">
                                <button onclick="showStudentDetail(${s.student_id})" style="width:100%;padding:8px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;cursor:pointer">
                                    üìñ Xem chi ti·∫øt
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08)">
                        <h3 style="margin:0 0 20px 0;color:#374151">Danh s√°ch sinh vi√™n (${students.length})</h3>
                        <div class="students-grid">
                            ${cards}
                        </div>
                    </div>
                `;
            }
        }

        function drawLevelChart(stats) {
            const ctx = document.getElementById('levelChart');
            if (!ctx) return;

            // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
            if (levelChart) {
                levelChart.destroy();
            }

            const levelNames = {
                'Xuat sac': 'Xu·∫•t s·∫Øc',
                'Kha': 'Kh√°',
                'Trung binh': 'Trung b√¨nh',
                'Yeu': 'Y·∫øu'
            };

            const labels = Object.keys(stats.level_counts || {}).map(l => levelNames[l] || l);
            const data = Object.values(stats.level_counts || {});
            const colors = ['#4CAF50', '#2196F3', '#FF9800', '#f44336'];

            levelChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng sinh vi√™n',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawCourseScoreChart(students, skillEvaluations) {
            const ctx = document.getElementById('courseScoreChart');
            if (!ctx || !students || students.length === 0) return;

            // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
            if (courseScoreChart) {
                courseScoreChart.destroy();
            }

            const courseNames = Object.keys(COURSES);
            const avgScores = courseNames.map(courseName => {
                const courseStudents = students.filter(s => s.courses && s.courses[courseName]);
                if (courseStudents.length === 0) return 0;
                const total = courseStudents.reduce((sum, s) => sum + (s.courses[courseName].score || 0), 0);
                return Math.round((total / courseStudents.length) * 10) / 10; // L√†m tr√≤n 1 ch·ªØ s·ªë th·∫≠p ph√¢n
            });

            courseScoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: courseNames.map(name => name.substring(0, 20) + (name.length > 20 ? '...' : '')),
                    datasets: [{
                        label: 'ƒêi·ªÉm trung b√¨nh',
                        data: avgScores,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'ƒêi·ªÉm s·ªë (0-10)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = Math.round(context.parsed.y * 10) / 10;
                                    return `ƒêi·ªÉm: ${value}/10`;
                                }
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const courseName = courseNames[index];
                            
                            // L·ªçc sinh vi√™n c√≥ h·ªçc m√¥n n√†y
                            const filteredStudents = students.filter(student => {
                                return student.courses && student.courses[courseName];
                            });
                            
                            console.log(`Clicked on ${courseName}: ${filteredStudents.length} students`);
                            renderStudentList(filteredStudents);
                            
                            // Scroll xu·ªëng danh s√°ch
                            setTimeout(() => {
                                const studentsList = document.getElementById('studentsList');
                                if (studentsList) {
                                    studentsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            }, 100);
                        }
                    }
                }
            });
        }

        function drawSkillPassChart(students, skillEvaluations) {
            const ctx = document.getElementById('skillPassChart');
            if (!ctx || !students || students.length === 0) return;

            // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
            if (skillPassChart) {
                skillPassChart.destroy();
            }

            const courseNames = Object.keys(COURSES);
            const passRates = courseNames.map(courseName => {
                let totalSkills = 0;
                let passedSkills = 0;
                
                students.forEach(student => {
                    if (student.courses && student.courses[courseName]) {
                        const studentId = student.student_id;
                        let skillInfo = skillEvaluations[studentId]?.[courseName];
                        
                        // N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m v·ªõi t√™n r√∫t g·ªçn ho·∫∑c t√™n kh√°c
                        if (!skillInfo && skillEvaluations[studentId]) {
                            const studentSkills = skillEvaluations[studentId];
                            const possibleNames = Object.keys(studentSkills);
                            const altName = possibleNames.find(name => 
                                name.includes(courseName.split(' ')[0]) || courseName.includes(name.split(' ')[0])
                            );
                            if (altName) {
                                skillInfo = studentSkills[altName];
                            }
                        }
                        
                        if (skillInfo && skillInfo.skills_summary) {
                            totalSkills += skillInfo.skills_summary.total_skills || 0;
                            passedSkills += skillInfo.skills_summary.passed_skills || 0;
                        }
                    }
                });
                
                return totalSkills > 0 ? (passedSkills / totalSkills * 100) : 0;
            });

            skillPassChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: courseNames.map(name => name.substring(0, 20) + (name.length > 20 ? '...' : '')),
                    datasets: [{
                        label: 'T·ª∑ l·ªá k·ªπ nƒÉng ƒë·∫°t (%)',
                        data: passRates,
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#4CAF50',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'T·ª∑ l·ªá ƒë·∫°t (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `T·ª∑ l·ªá ƒë·∫°t: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const courseName = courseNames[index];
                            
                            // L·ªçc sinh vi√™n c√≥ h·ªçc m√¥n n√†y
                            const filteredStudents = students.filter(student => {
                                return student.courses && student.courses[courseName];
                            });
                            
                            console.log(`Clicked on ${courseName}: ${filteredStudents.length} students`);
                            renderStudentList(filteredStudents);
                            
                            // Scroll xu·ªëng danh s√°ch
                            setTimeout(() => {
                                const studentsList = document.getElementById('studentsList');
                                if (studentsList) {
                                    studentsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            }, 100);
                        }
                    }
                }
            });
        }

        function drawTimeChart(students) {
            const ctx = document.getElementById('timeChart');
            if (!ctx || !students || students.length === 0) return;

            // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
            if (timeChart) {
                timeChart.destroy();
            }

            // Ph√¢n nh√≥m th·ªùi gian: 0-20, 21-40, 41-60, 61-80, 81+
            const timeRanges = ['0-20 ph√∫t', '21-40 ph√∫t', '41-60 ph√∫t', '61-80 ph√∫t', '81+ ph√∫t'];
            const timeCounts = [0, 0, 0, 0, 0];

            students.forEach(student => {
                if (student.courses) {
                    Object.values(student.courses).forEach(course => {
                        const time = course.time_minutes || 0;
                        if (time <= 20) timeCounts[0]++;
                        else if (time <= 40) timeCounts[1]++;
                        else if (time <= 60) timeCounts[2]++;
                        else if (time <= 80) timeCounts[3]++;
                        else timeCounts[4]++;
                    });
                }
            });

            timeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: timeRanges,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng b√†i l√†m',
                        data: timeCounts,
                        backgroundColor: [
                            'rgba(244, 67, 54, 0.7)',
                            'rgba(255, 152, 0, 0.7)',
                            'rgba(33, 150, 243, 0.7)',
                            'rgba(76, 175, 80, 0.7)',
                            'rgba(102, 126, 234, 0.7)'
                        ],
                        borderColor: [
                            'rgba(244, 67, 54, 1)',
                            'rgba(255, 152, 0, 1)',
                            'rgba(33, 150, 243, 1)',
                            'rgba(76, 175, 80, 1)',
                            'rgba(102, 126, 234, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'S·ªë l∆∞·ª£ng',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Kho·∫£ng th·ªùi gian',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `S·ªë l∆∞·ª£ng: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const timeRange = timeRanges[index];
                            
                            // L·ªçc sinh vi√™n theo kho·∫£ng th·ªùi gian
                            const filteredStudents = students.filter(student => {
                                if (!student.courses) return false;
                                
                                // T√≠nh th·ªùi gian trung b√¨nh
                                let totalTime = 0;
                                let count = 0;
                                Object.values(student.courses).forEach(course => {
                                    if (course.time_minutes !== undefined) {
                                        totalTime += course.time_minutes;
                                        count++;
                                    }
                                });
                                const avgTime = count > 0 ? totalTime / count : 0;
                                
                                // Ki·ªÉm tra thu·ªôc kho·∫£ng n√†o
                                if (index === 0) return avgTime <= 20;
                                else if (index === 1) return avgTime > 20 && avgTime <= 40;
                                else if (index === 2) return avgTime > 40 && avgTime <= 60;
                                else if (index === 3) return avgTime > 60 && avgTime <= 80;
                                else return avgTime > 80;
                            });
                            
                            console.log(`Clicked on ${timeRange}: ${filteredStudents.length} students`);
                            renderStudentList(filteredStudents);
                            
                            // Scroll xu·ªëng danh s√°ch
                            setTimeout(() => {
                                const studentsList = document.getElementById('studentsList');
                                if (studentsList) {
                                    studentsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            }, 100);
                        }
                    }
                }
            });
        }

        function setupCourseTabs() {
            const tabsContainer = document.getElementById('courseTabs');
            tabsContainer.innerHTML = Object.keys(COURSES).map((courseName, index) => `
                <div class="course-tab ${index === 0 ? 'active' : ''}" 
                     onclick="switchCourse('${courseName}')">
                    ${COURSES[courseName].icon} ${courseName}
                </div>
            `).join('');
        }

        function switchCourse(courseName) {
            currentCourse = courseName;
            document.querySelectorAll('.course-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.includes(courseName)) {
                    tab.classList.add('active');
                }
            });
            displayCourseContent(courseName);
        }

        function displayCourseContent(courseName) {
            const container = document.getElementById('courseContent');
            const students = coursesData[courseName] || [];
            const courseInfo = COURSES[courseName];
            const levelNames = {
                'Xuat sac': 'Xu·∫•t s·∫Øc',
                'Kha': 'Kh√°',
                'Trung binh': 'Trung b√¨nh',
                'Yeu': 'Y·∫øu'
            };

            let content = `
                <div class="course-content active">
                    <div class="course-header">
                        <h2>${courseInfo.icon} ${courseName}</h2>
                        <p style="color: #666; font-size: 1.1em;">T·ªïng s·ªë sinh vi√™n: ${students.length}</p>
                    </div>
            `;

            if (students.length === 0) {
                content += '<div class="loading">Ch∆∞a c√≥ d·ªØ li·ªáu sinh vi√™n cho m√¥n h·ªçc n√†y</div>';
            } else {
                content += '<div class="students-grid">';
                
                students.forEach(student => {
                    const studentId = student.student_id;
                    const finalLevel = student.final_level || 'Unknown';
                    const levelClass = finalLevel.toLowerCase().replace(' ', '-');
                    const courseData = student.courses[courseName];
                    const skillEval = skillEvaluations[studentId]?.[courseName];

                    let skillsHtml = '';
                    if (skillEval && skillEval.skills) {
                        const skillsSummary = skillEval.skills_summary || {};
                        skillsHtml = `
                            <div class="skills-summary">
                                <h4>üìã K·ªπ nƒÉng: ${skillsSummary.passed_skills || 0}/${skillsSummary.total_skills || 4} ƒë·∫°t</h4>
                                ${Object.entries(skillEval.skills).slice(0, 2).map(([skillName, skillData]) => `
                                    <div class="skill-item ${skillData.passed ? 'passed' : 'failed'}">
                                        <span class="skill-name">${skillName}</span>
                                        <span class="skill-score">${skillData.score}/10</span>
                                        <span class="skill-status">${skillData.passed ? '‚úì' : '‚úó'}</span>
                                    </div>
                                `).join('')}
                                ${Object.keys(skillEval.skills).length > 2 ? 
                                    `<p style="text-align: center; margin-top: 10px; color: #667eea; cursor: pointer;" 
                                        onclick="showStudentDetail(${studentId})">Xem th√™m...</p>` : ''}
                            </div>
                        `;
                    }

                    content += `
                        <div class="student-card">
                            <h3>${student.name || `Sinh vi√™n ${studentId}`}</h3>
                            <span class="level ${levelClass}">${levelNames[finalLevel] || finalLevel}</span>
                            
                            ${student.anomaly_detected ? `
                                <div class="anomaly">
                                    ‚ö†Ô∏è ${student.anomaly_reason || 'Ph√°t hi·ªán b·∫•t th∆∞·ªùng'}
                                </div>
                            ` : ''}
                            
                            <div class="course-info">
                                <strong>${courseName}</strong><br>
                                üìä ƒêi·ªÉm: <strong style="color: #667eea;">${formatScore(courseData.score)}/10</strong><br>
                                ‚è±Ô∏è Th·ªùi gian: <strong>${formatNumber(courseData.time_minutes)} ph√∫t</strong>
                            </div>
                            
                            ${skillsHtml}
                            
                            <button onclick="showStudentDetail(${studentId})" 
                                    style="margin-top: 15px; width: 100%;">
                                üìñ Xem Chi Ti·∫øt ƒê·∫ßy ƒê·ªß
                            </button>
                        </div>
                    `;
                });

                content += '</div>';
            }

            content += '</div>';
            container.innerHTML = content;
        }

        async function showStudentDetail(studentId) {
            try {
                const response = await fetch(`${API_BASE}/api/student/${studentId}`);
                const data = await response.json();
                
                const student = data.student;
                const skillEval = data.skill_evaluations;
                const levelNames = {
                    'Xuat sac': 'Xu·∫•t s·∫Øc',
                    'Kha': 'Kh√°',
                    'Trung binh': 'Trung b√¨nh',
                    'Yeu': 'Y·∫øu'
                };
                
                // D√πng h√†m t√≠nh level chung
                const calculatedLevel = calculateStudentLevel(student);
                
                // T√≠nh to√°n c√°c gi√° tr·ªã ƒë·ªÉ hi·ªÉn th·ªã chi ti·∫øt
                const avgScore = Object.values(student.courses || {}).reduce((sum, course) => sum + (course.score || 0), 0) / Object.keys(student.courses || {}).length;
                // T·ªïng th·ªùi gian (kh√¥ng ph·∫£i trung b√¨nh)
                const totalTime = Object.values(student.courses || {}).reduce((sum, course) => sum + (course.time_minutes || 0), 0);
                const avgTime = totalTime / Object.keys(student.courses || {}).length;
                const timeInHours = totalTime / 60;
                const csvData = student.csv_data || {};
                const attendance = parseFloat(csvData.attendance_rate || 0) * 100;
                const lateSubmissions = parseInt(csvData.late_submissions || 0);
                
                // T√≠nh ƒëi·ªÉm c√°c y·∫øu t·ªë (ƒë·ªÉ hi·ªÉn th·ªã trong b·∫£ng)
                let scorePoints = 0;
                if (avgScore >= 9.0) scorePoints = 35;
                else if (avgScore >= 8.0) scorePoints = 30;
                else if (avgScore >= 7.0) scorePoints = 25;
                else if (avgScore >= 6.0) scorePoints = 20;
                else if (avgScore >= 5.0) scorePoints = 15;
                else scorePoints = 8;
                
                let timePoints = 0;
                if (timeInHours >= 15) timePoints = 25;
                else if (timeInHours >= 12) timePoints = 22;
                else if (timeInHours >= 10) timePoints = 18;
                else if (timeInHours >= 8) timePoints = 14;
                else if (timeInHours >= 5) timePoints = 10;
                else timePoints = 5;
                
                // T√≠nh t·ªïng s·ªë b√†i t·∫≠p
                const totalAssignments = Object.keys(student.courses || {}).length * 30;
                const lateRate = totalAssignments > 0 ? (lateSubmissions / totalAssignments) * 100 : 0;
                
                let attendancePoints = 0;
                if (attendance >= 95) attendancePoints = 20;
                else if (attendance >= 90) attendancePoints = 18;
                else if (attendance >= 80) attendancePoints = 15;
                else if (attendance >= 70) attendancePoints = 12;
                else if (attendance >= 60) attendancePoints = 8;
                else attendancePoints = 4;
                
                // K·ª∑ lu·∫≠t - D·ª±a tr√™n t·ª∑ l·ªá n·ªôp mu·ªôn (t√≠nh tuy·∫øn t√≠nh)
                let behaviorPoints = Math.max(0, 10 - (lateRate / 5));
                behaviorPoints = Math.round(behaviorPoints * 10) / 10; // L√†m tr√≤n 1 ch·ªØ s·ªë th·∫≠p ph√¢n
                
                const courseScores = Object.values(student.courses || {}).map(c => c.score || 0);
                const scoreStdDev = courseScores.length > 0 ? 
                    Math.sqrt(courseScores.reduce((sum, s) => sum + Math.pow(s - avgScore, 2), 0) / courseScores.length) : 0;
                let consistencyPoints = 0;
                if (scoreStdDev < 0.5) consistencyPoints = 10;
                else if (scoreStdDev < 1.0) consistencyPoints = 8;
                else if (scoreStdDev < 1.5) consistencyPoints = 6;
                else if (scoreStdDev < 2.0) consistencyPoints = 4;
                else consistencyPoints = 2;
                
                const totalPoints = scorePoints + timePoints + attendancePoints + behaviorPoints + consistencyPoints;
                
                // S·ª≠ d·ª•ng analyzeStudentIssues ƒë·ªÉ t√≠nh penalty ƒë·ªìng b·ªô
                const analysisForPenalty = analyzeStudentIssues(student);
                const totalPenalty = analysisForPenalty.totalPenalty;
                
                const finalPoints = Math.max(0, totalPoints - totalPenalty);
                
                let modalHtml = `
                    <h2 style="color: #667eea; margin-bottom: 20px;">
                        üìä ${student.name || `Sinh vi√™n ${studentId}`}
                    </h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Ph√¢n Lo·∫°i T·ªïng Quan</h3>
                        <p><strong>ƒêi·ªÉm trung b√¨nh:</strong> <span style="color: #667eea; font-weight: bold;">${formatScore(calculateAverageScore(student))}/10</span></p>
                        <p><strong>T·ªïng th·ªùi gian h·ªçc:</strong> <span style="color: #667eea; font-weight: bold;">${formatTime(calculateTotalTime(student))}</span></p>
                        <p><strong>K·∫øt qu·∫£ ƒë√°nh gi√°:</strong> <span class="level ${calculatedLevel.toLowerCase().replace(' ', '-')}">${levelNames[calculatedLevel]}</span></p>
                        ${explainLevel(student)}
                        ${(() => {
                            const analysis = analyzeStudentIssues(student);
                            if (analysis.hasAnomaly && analysis.issues.length > 0) {
                                return `
                                    <div class="anomaly" style="margin-top: 15px;">
                                        ‚ö†Ô∏è ${analysis.issues.map(i => i.text).join('; ')}
                                    </div>
                                `;
                            }
                            return '';
                        })()}
                        
                        <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 10px; border-left: 4px solid #667eea;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">üìù Ph√¢n T√≠ch C√°c Y·∫øu T·ªë H·ªçc T·∫≠p (K-means/KNN):</h4>
                            <div style="color: #444; line-height: 1.8;">
                                ${(() => {
                                    // S·ª≠ d·ª•ng h√†m ph√¢n t√≠ch chung ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi ph·∫ßn "Ph√°t hi·ªán b·∫•t th∆∞·ªùng"
                                    const analysis = analyzeStudentIssues(student);
                                    let penalties = analysis.issues.map(i => ({
                                        text: i.text,
                                        points: i.points,
                                        severity: i.severity,
                                        type: i.type || 'warning'
                                    }));
                                    
                                    // T·∫°o danh s√°ch m√¥n h·ªçc
                                    const courseNames = Object.keys(student.courses || {});
                                    const courseOptions = courseNames.map(name => `<option value="${name}">${name}</option>`).join('');
                                    
                                    return `
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                <h5 style="color: #667eea; margin: 0;">üìä C√°c y·∫øu t·ªë ƒë∆∞·ª£c K-means/KNN s·ª≠ d·ª•ng ƒë·ªÉ ph√¢n lo·∫°i</h5>
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <label style="font-weight: bold; color: #333;">L·ªçc theo m√¥n:</label>
                                                    <select id="courseFilter_${student.student_id}" onchange="updateScoreTable(${student.student_id})" 
                                                        style="padding: 8px 12px; border: 2px solid #667eea; border-radius: 5px; font-size: 14px; cursor: pointer; background: white;">
                                                        <option value="all">üìö T·∫•t c·∫£ m√¥n</option>
                                                        ${courseOptions}
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div id="scoreTableContainer_${student.student_id}">
                                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                                                <thead>
                                                    <tr style="background: #667eea; color: white;">
                                                        <th style="padding: 10px; text-align: left; border-radius: 5px 0 0 0;">Y·∫øu t·ªë</th>
                                                        <th style="padding: 10px; text-align: center; border-radius: 0 5px 0 0;">Gi√° tr·ªã</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr style="background: white;">
                                                        <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>üìä ƒêi·ªÉm trung b√¨nh</strong></td>
                                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${avgScore >= 8 ? '#28a745' : avgScore >= 6.5 ? '#17a2b8' : avgScore >= 5 ? '#ffc107' : '#dc3545'};">${formatNumber(avgScore)}/10</td>
                                                    </tr>
                                                    <tr style="background: #f8f9fa;">
                                                        <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>‚è±Ô∏è T·ªïng th·ªùi gian h·ªçc</strong></td>
                                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${timeInHours >= 10 ? '#28a745' : timeInHours >= 5 ? '#17a2b8' : '#ffc107'};">${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m</td>
                                                    </tr>
                                                    <tr style="background: white;">
                                                        <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>‚úÖ T·ª∑ l·ªá tham d·ª±</strong></td>
                                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${attendance >= 80 ? '#28a745' : attendance >= 60 ? '#ffc107' : '#dc3545'};">${Math.round(attendance)}%</td>
                                                    </tr>
                                                    <tr style="background: #f8f9fa;">
                                                        <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>üìù N·ªôp b√†i tr·ªÖ</strong></td>
                                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${lateSubmissions <= 3 ? '#28a745' : lateSubmissions <= 8 ? '#ffc107' : '#dc3545'};">${lateSubmissions} l·∫ßn</td>
                                                    </tr>
                                                    <tr style="background: white;">
                                                        <td style="padding: 10px; border-bottom: 1px solid #ddd;"><strong>üìà T√≠nh nh·∫•t qu√°n ƒëi·ªÉm</strong></td>
                                                        <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: ${scoreStdDev < 1 ? '#28a745' : scoreStdDev < 2 ? '#ffc107' : '#dc3545'};">${scoreStdDev < 1 ? '·ªîn ƒë·ªãnh' : scoreStdDev < 2 ? 'Trung b√¨nh' : 'Kh√¥ng ·ªïn ƒë·ªãnh'}</td>
                                                    </tr>
                                                    <tr style="background: ${penalties.length > 0 ? (penalties.some(p => p.type === 'anomaly') ? '#f8d7da' : '#fff3cd') : '#d4edda'};">
                                                        <td colspan="2" style="padding: 15px; border-radius: 0 0 5px 5px;">
                                                            ${(() => {
                                                                const anomalies = penalties.filter(p => p.type === 'anomaly');
                                                                const warnings = penalties.filter(p => p.type === 'warning' || !p.type);
                                                                
                                                                if (anomalies.length > 0) {
                                                                    // C√≥ b·∫•t th∆∞·ªùng (nghi gian l·∫≠n)
                                                                    return '<strong style="color: #dc3545; font-size: 16px;">üö® Ph√°t hi·ªán ' + anomalies.length + ' b·∫•t th∆∞·ªùng:</strong>' +
                                                                        '<div style="margin-top: 10px;">' +
                                                                        anomalies.map((p, idx) => {
                                                                            let color = p.severity === 'critical' ? '#dc3545' : '#ff6b6b';
                                                                            return '<div style="background: white; padding: 8px 12px; margin: 5px 0; border-radius: 5px; border-left: 4px solid ' + color + ';"><span style="color: ' + color + '; font-weight: bold;">üö® ' + (idx + 1) + '. ' + p.text + '</span></div>';
                                                                        }).join('') +
                                                                        '</div>' +
                                                                        (warnings.length > 0 ? '<div style="margin-top: 15px;"><strong style="color: #ffc107; font-size: 14px;">‚ö†Ô∏è V√† ' + warnings.length + ' c·∫£nh b√°o kh√°c:</strong>' +
                                                                        '<div style="margin-top: 5px;">' +
                                                                        warnings.map((p, idx) => {
                                                                            let color = p.severity === 'high' ? '#ff9800' : '#ffc107';
                                                                            return '<div style="background: #fffbf0; padding: 6px 10px; margin: 3px 0; border-radius: 4px; border-left: 3px solid ' + color + '; font-size: 13px;"><span style="color: ' + color + ';">‚ö†Ô∏è ' + p.text + '</span></div>';
                                                                        }).join('') +
                                                                        '</div></div>' : '');
                                                                } else if (warnings.length > 0) {
                                                                    // Ch·ªâ c√≥ c·∫£nh b√°o (c·∫ßn c·∫£i thi·ªán)
                                                                    return '<strong style="color: #ff9800; font-size: 16px;">‚ö†Ô∏è Ph√°t hi·ªán ' + warnings.length + ' v·∫•n ƒë·ªÅ c·∫ßn c·∫£i thi·ªán:</strong>' +
                                                                        '<div style="margin-top: 10px;">' +
                                                                        warnings.map((p, idx) => {
                                                                            let color = p.severity === 'high' ? '#ff6b6b' : p.severity === 'medium' ? '#ff9800' : '#ffc107';
                                                                            let icon = p.severity === 'high' ? '‚ö†Ô∏è' : p.severity === 'medium' ? 'üìä' : 'üí°';
                                                                            return '<div style="background: white; padding: 8px 12px; margin: 5px 0; border-radius: 5px; border-left: 4px solid ' + color + ';"><span style="color: ' + color + '; font-weight: bold;">' + icon + ' ' + (idx + 1) + '. ' + p.text + '</span></div>';
                                                                        }).join('') +
                                                                        '</div>';
                                                                } else {
                                                                    // Kh√¥ng c√≥ v·∫•n ƒë·ªÅ
                                                                    return '<strong style="color: #28a745; font-size: 16px;">‚úÖ Kh√¥ng ph√°t hi·ªán v·∫•n ƒë·ªÅ</strong>' +
                                                                        '<div style="margin-top: 5px; color: #666;">Sinh vi√™n c√≥ h√†nh vi h·ªçc t·∫≠p t·ªët, kh√¥ng c√≥ d·∫•u hi·ªáu b·∫•t th∆∞·ªùng.</div>';
                                                                }
                                                            })()}
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            </div>
                                        </div>
                                    `;
                                })()}
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 10px; border-left: 4px solid #667eea;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">üí° Gi·∫£i th√≠ch x·∫øp lo·∫°i:</h4>
                            <div style="color: #444; line-height: 1.8;">
                                ${(() => {
                                    // S·ª≠ d·ª•ng h√†m ph√¢n t√≠ch chung ƒë·ªÉ ƒë·ªìng b·ªô
                                    const analysis = analyzeStudentIssues(student);
                                    const { avgScore, timeInHours, totalTime, attendance, lateSubmissions } = analysis.stats;
                                    const level = calculateStudentLevel(student);
                                    
                                    // Hi·ªÉn th·ªã v·∫•n ƒë·ªÅ n·∫øu c√≥
                                    let issuesHtml = '';
                                    if (analysis.issues.length > 0) {
                                        issuesHtml = `
                                            <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 10px;">
                                                <strong>‚ö†Ô∏è Ph√°t hi·ªán v·∫•n ƒë·ªÅ:</strong><br>
                                                ${analysis.issues.map(i => `‚Ä¢ ${i.text}`).join('<br>')}
                                            </div>
                                        `;
                                    }
                                    
                                    if (level === 'Xuat sac') {
                                        return issuesHtml + `
                                            <div style="background: #d4edda; padding: 12px; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 10px;">
                                                <strong>üéØ Xu·∫•t s·∫Øc</strong><br>
                                                ‚Ä¢ ƒêi·ªÉm trung b√¨nh: <strong>${formatNumber(avgScore)}/10</strong><br>
                                                ‚Ä¢ Th·ªùi gian h·ªçc: <strong>${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m</strong><br>
                                                ‚Ä¢ Tham gia: <strong>${Math.round(attendance)}%</strong><br>
                                                ‚Ä¢ N·ªôp mu·ªôn: <strong>${lateSubmissions} l·∫ßn</strong><br>
                                                ‚Ä¢ ƒê√°nh gi√°: K·∫øt qu·∫£ h·ªçc t·∫≠p xu·∫•t s·∫Øc
                                            </div>
                                            <div style="background: #e7f3ff; padding: 10px; border-radius: 8px;">
                                                <strong>üí° ƒê·ªÅ xu·∫•t:</strong> Ti·∫øp t·ª•c duy tr√¨ ph∆∞∆°ng ph√°p h·ªçc t·∫≠p hi·ªáu qu·∫£.
                                            </div>
                                        `;
                                    } else if (level === 'Kha') {
                                        return issuesHtml + `
                                            <div style="background: #d1ecf1; padding: 12px; border-radius: 8px; border-left: 4px solid #17a2b8; margin-bottom: 10px;">
                                                <strong>üéØ Kh√°</strong><br>
                                                ‚Ä¢ ƒêi·ªÉm trung b√¨nh: <strong>${formatNumber(avgScore)}/10</strong><br>
                                                ‚Ä¢ Th·ªùi gian h·ªçc: <strong>${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m</strong><br>
                                                ‚Ä¢ Tham gia: <strong>${Math.round(attendance)}%</strong><br>
                                                ‚Ä¢ N·ªôp mu·ªôn: <strong>${lateSubmissions} l·∫ßn</strong><br>
                                                ‚Ä¢ ƒê√°nh gi√°: K·∫øt qu·∫£ t·ªët
                                            </div>
                                            <div style="background: #e7f3ff; padding: 10px; border-radius: 8px;">
                                                <strong>üí° ƒê·ªÅ xu·∫•t:</strong> TƒÉng c∆∞·ªùng th·ª±c h√†nh ƒë·ªÉ ƒë·∫°t m·ª©c xu·∫•t s·∫Øc.
                                            </div>
                                        `;
                                    } else if (level === 'Trung binh') {
                                        return issuesHtml + `
                                            <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 10px;">
                                                <strong>üéØ Trung b√¨nh</strong><br>
                                                ‚Ä¢ ƒêi·ªÉm trung b√¨nh: <strong>${formatNumber(avgScore)}/10</strong><br>
                                                ‚Ä¢ Th·ªùi gian h·ªçc: <strong>${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m</strong><br>
                                                ‚Ä¢ Tham gia: <strong>${Math.round(attendance)}%</strong><br>
                                                ‚Ä¢ N·ªôp mu·ªôn: <strong>${lateSubmissions} l·∫ßn</strong><br>
                                                ‚Ä¢ ƒê√°nh gi√°: C·∫ßn c·∫£i thi·ªán
                                            </div>
                                            <div style="background: #e7f3ff; padding: 10px; border-radius: 8px;">
                                                <strong>üí° ƒê·ªÅ xu·∫•t:</strong> TƒÉng th·ªùi gian th·ª±c h√†nh v√† trao ƒë·ªïi v·ªõi gi·∫£ng vi√™n.
                                            </div>
                                        `;
                                    } else if (level === 'Yeu') {
                                        
                                        return issuesHtml + `
                                            <div style="background: #f8d7da; padding: 12px; border-radius: 8px; border-left: 4px solid #dc3545; margin-bottom: 10px;">
                                                <strong>‚ö†Ô∏è Y·∫øu</strong><br><br>
                                                ‚Ä¢ ƒêi·ªÉm trung b√¨nh: <strong>${formatNumber(avgScore)}/10</strong><br>
                                                ‚Ä¢ Th·ªùi gian h·ªçc: <strong>${Math.floor(timeInHours)}h ${Math.round(totalTime%60)}m</strong><br>
                                                ‚Ä¢ Tham gia: <strong>${Math.round(attendance)}%</strong><br>
                                                ‚Ä¢ N·ªôp mu·ªôn: <strong>${lateSubmissions} l·∫ßn</strong><br>
                                                ‚Ä¢ ƒê√°nh gi√°: C·∫ßn c·∫£i thi·ªán kh·∫©n c·∫•p
                                            </div>
                                            <div style="background: #e7f3ff; padding: 10px; border-radius: 8px;">
                                                <strong>üí° ƒê·ªÅ xu·∫•t:</strong><br>
                                                ‚Ä¢ G·∫∑p gi·∫£ng vi√™n ƒë·ªÉ ƒë∆∞·ª£c h∆∞·ªõng d·∫´n<br>
                                                ‚Ä¢ Tham gia nh√≥m h·ªçc t·∫≠p<br>
                                                ‚Ä¢ L·∫≠p k·∫ø ho·∫°ch h·ªçc t·∫≠p r√µ r√†ng
                                            </div>
                                        `;
                                    } else {
                                        return `<em style="color: #999;">Ch∆∞a c√≥ ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ƒë√°nh gi√° chi ti·∫øt.</em>`;
                                    }
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 20px 0;">
                        <h3 style="color: #667eea; margin: 0;">üìö Chi Ti·∫øt Theo M√¥n H·ªçc</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-weight: bold; color: #333;">L·ªçc m√¥n:</label>
                            <select id="modalCourseFilter_${studentId}" onchange="filterModalCourses(${studentId})" 
                                style="padding: 8px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                                <option value="all">üìö T·∫•t c·∫£ m√¥n</option>
                                ${Object.keys(COURSES).map(name => `<option value="${name}">${COURSES[name].icon} ${name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div id="courseDetailsContainer_${studentId}">
                `;

                Object.keys(COURSES).forEach((courseName, index) => {
                    if (student.courses && student.courses[courseName]) {
                        const courseData = student.courses[courseName];
                        const skillInfo = skillEval[courseName];
                        const courseDef = COURSES[courseName];
                        const chartId = `courseChart_${index}`;

                        modalHtml += `
                            <div class="course-detail-item" data-course="${courseName}" style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border-left: 5px solid #667eea;">
                                <h4 style="color: #667eea; font-size: 1.4em; margin-bottom: 15px;">
                                    ${courseDef.icon} ${courseName}
                                </h4>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s;" 
                                         onclick="toggleExerciseDetails('${courseName.replace(/'/g, "\\'")}', ${studentId})"
                                         onmouseover="this.style.background='#e3f2fd'; this.style.transform='translateY(-2px)'"
                                         onmouseout="this.style.background='#f8f9fa'; this.style.transform='translateY(0)'">
                                        <strong style="color: #667eea;">üìä ƒêi·ªÉm TB</strong><br>
                                        <span style="font-size: 1.5em; font-weight: bold; color: #667eea;">
                                            ${formatScore(courseData.score)}/10
                                        </span>
                                        <div style="font-size: 12px; color: #999; margin-top: 5px;">Click xem b√†i t·∫≠p</div>
                                    </div>
                                    <div style="background: #fff3e0; padding: 15px; border-radius: 10px;">
                                        <strong style="color: #ff9800;">üìù Gi·ªØa k·ª≥</strong><br>
                                        <span style="font-size: 1.3em; font-weight: bold; color: ${(courseData.midterm_score || 0) >= 5 ? '#28a745' : '#dc3545'};">
                                            ${formatScore(courseData.midterm_score || 0)}/10
                                        </span>
                                    </div>
                                    <div style="background: #e8f5e9; padding: 15px; border-radius: 10px;">
                                        <strong style="color: #4caf50;">üéì Cu·ªëi k·ª≥</strong><br>
                                        <span style="font-size: 1.3em; font-weight: bold; color: ${(courseData.final_score || 0) >= 5 ? '#28a745' : '#dc3545'};">
                                            ${formatScore(courseData.final_score || 0)}/10
                                        </span>
                                    </div>
                                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px;">
                                        <strong style="color: #2196f3;">üìö B√†i t·∫≠p</strong><br>
                                        <span style="font-size: 1.3em; font-weight: bold; color: ${(courseData.homework_score || 0) >= 5 ? '#28a745' : '#dc3545'};">
                                            ${formatScore(courseData.homework_score || 0)}/10
                                        </span>
                                    </div>
                                    <div style="background: #f3e5f5; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s;" 
                                         onclick="toggleTimeDetails('${courseName.replace(/'/g, "\\'")}', ${studentId})"
                                         onmouseover="this.style.background='#e1bee7'; this.style.transform='translateY(-2px)'"
                                         onmouseout="this.style.background='#f3e5f5'; this.style.transform='translateY(0)'">
                                        <strong style="color: #9c27b0;">‚è±Ô∏è Th·ªùi gian</strong><br>
                                        <span style="font-size: 1.3em; font-weight: bold; color: #9c27b0;">
                                            ${Math.floor(courseData.time_minutes / 60)}h ${Math.round(courseData.time_minutes % 60)}m
                                        </span>
                                        <div style="font-size: 11px; color: #999; margin-top: 3px;">Click xem chi ti·∫øt</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                    <h5 style="color: #667eea; margin-bottom: 15px;">üìà Bi·ªÉu ƒë·ªì ƒëi·ªÉm s·ªë chi ti·∫øt</h5>
                                    <div style="position: relative; height: 300px; width: 100%;">
                                        <canvas id="${chartId}"></canvas>
                                    </div>
                                </div>

                                ${skillInfo ? `
                                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-top: 20px;">
                                        <h5 style="color: #667eea; margin-bottom: 15px;">
                                            üîç Chi Ti·∫øt K·ªπ NƒÉng (${skillInfo.skills_summary?.passed_skills || 0}/${skillInfo.skills_summary?.total_skills || 4} ƒë·∫°t)
                                        </h5>
                                        ${Object.entries(skillInfo.skills || {}).map(([skillName, skillData]) => `
                                            <div class="skill-item ${skillData.passed ? 'passed' : 'failed'}" style="margin: 10px 0;">
                                                <span class="skill-name">${skillName}</span>
                                                <span class="skill-score">${skillData.score}/10</span>
                                                <span style="font-weight: 600; color: ${skillData.passed ? '#4CAF50' : '#f44336'};">
                                                    (${skillData.level})
                                                </span>
                                                <span class="skill-status">${skillData.passed ? '‚úì ƒê·∫°t' : '‚úó Ch∆∞a ƒë·∫°t'}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                
                                <!-- Container cho chi ti·∫øt b√†i t·∫≠p -->
                                <div id="exerciseDetails_${courseName.replace(/\s+/g, '_')}" style="display: none; margin-top: 20px;"></div>
                                
                                <!-- Container cho chi ti·∫øt th·ªùi gian -->
                                <div id="timeDetails_${courseName.replace(/\s+/g, '_')}" style="display: none; margin-top: 20px;"></div>
                            </div>
                        `;
                    }
                });
                
                // ƒê√≥ng container chi ti·∫øt m√¥n h·ªçc
                modalHtml += `</div>`;
                
                // L∆∞u d·ªØ li·ªáu integrated ƒë·ªÉ s·ª≠ d·ª•ng cho toggle chi ti·∫øt b√†i t·∫≠p
                if (data.integrated_data) {
                    currentIntegratedData = data.integrated_data;
                }
                
                document.getElementById('modalContent').innerHTML = modalHtml;
                document.getElementById('studentModal').style.display = 'block';

                // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì cho t·ª´ng m√¥n h·ªçc
                Object.keys(COURSES).forEach((courseName, index) => {
                    if (student.courses && student.courses[courseName]) {
                        const chartId = `courseChart_${index}`;
                        const ctx = document.getElementById(chartId);
                        if (ctx) {
                            const courseData = student.courses[courseName];
                            const skillInfo = skillEval[courseName];
                            
                            // Chu·∫©n b·ªã d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
                            const skillScores = [];
                            const skillLabels = [];
                            const backgroundColors = [];
                            
                            if (skillInfo && skillInfo.skills) {
                                Object.entries(skillInfo.skills).forEach(([skillName, skillData]) => {
                                    // B·ªè c√°c t·ª´ kh√¥ng c·∫ßn thi·∫øt v√† d·∫•u ngo·∫∑c
                                    let simplifiedName = skillName
                                        .replace(/\([^)]*\)/g, '')  // x√≥a n·ªôi dung trong ngo·∫∑c
                                        .replace('K·ªπ nƒÉng ', '')    // x√≥a "K·ªπ nƒÉng "
                                        .replace('Ki·∫øn th·ª©c ', '')  // x√≥a "Ki·∫øn th·ª©c "
                                        .trim();                    // x√≥a kho·∫£ng tr·∫Øng th·ª´a
                                    skillLabels.push(simplifiedName);
                                    skillScores.push(skillData.score);
                                    // M√†u xanh cho k·ªπ nƒÉng ƒë·∫°t, ƒë·ªè cho k·ªπ nƒÉng ch∆∞a ƒë·∫°t
                                    backgroundColors.push(skillData.passed ? 'rgba(76, 175, 80, 0.6)' : 'rgba(244, 67, 54, 0.6)');
                                });
                            }
                            
                            // Th√™m ƒëi·ªÉm t·ªïng v√†o cu·ªëi
                            skillLabels.push('T·ªïng');
                            skillScores.push(courseData.score);
                            backgroundColors.push('rgba(103, 126, 234, 0.6)');
                            
                            new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: skillLabels,
                                    datasets: [{
                                        label: 'ƒêi·ªÉm s·ªë',
                                        data: skillScores,
                                        backgroundColor: backgroundColors,
                                        borderColor: backgroundColors.map(color => color.replace('0.6', '1')),
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    layout: {
                                        padding: {
                                            left: 10,
                                            right: 20,
                                            top: 10,
                                            bottom: 10
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 10,
                                            grid: {
                                                color: 'rgba(0, 0, 0, 0.1)'
                                            },
                                            ticks: {
                                                stepSize: 2
                                            }
                                        },
                                        x: {
                                            grid: {
                                                display: false
                                            },
                                            ticks: {
                                                maxRotation: 0,
                                                autoSkip: false,
                                                font: {
                                                    size: 11
                                                }
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    return `ƒêi·ªÉm: ${context.raw.toFixed(1)}/10`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }
                });
            } catch (error) {
                alert('L·ªói khi t·∫£i chi ti·∫øt: ' + error.message);
            }
        }

        // L∆∞u tr·ªØ d·ªØ li·ªáu integrated ƒë·ªÉ s·ª≠ d·ª•ng cho toggle
        let currentIntegratedData = null;
        
        async function toggleExerciseDetails(courseName, studentId) {
            const containerId = `exerciseDetails_${courseName.replace(/\s+/g, '_')}`;
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            // ƒê√≥ng t·∫•t c·∫£ c√°c chi ti·∫øt b√†i t·∫≠p v√† th·ªùi gian kh√°c
            Object.keys(COURSES).forEach(course => {
                const otherExerciseId = `exerciseDetails_${course.replace(/\s+/g, '_')}`;
                const otherTimeId = `timeDetails_${course.replace(/\s+/g, '_')}`;
                const otherExercise = document.getElementById(otherExerciseId);
                const otherTime = document.getElementById(otherTimeId);
                if (otherExercise && otherExerciseId !== containerId) {
                    otherExercise.style.display = 'none';
                }
                if (otherTime) {
                    otherTime.style.display = 'none';
                }
            });
            
            // Toggle hi·ªÉn th·ªã m√¥n hi·ªán t·∫°i
            if (container.style.display === 'none' || container.style.display === '') {
                // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu, load t·ª´ API
                if (!currentIntegratedData) {
                    try {
                        const response = await fetch(`${API_BASE}/api/student/${studentId}`);
                        const data = await response.json();
                        currentIntegratedData = data.integrated_data;
                    } catch (error) {
                        alert('L·ªói khi t·∫£i d·ªØ li·ªáu b√†i t·∫≠p: ' + error.message);
                        return;
                    }
                }
                
                // Hi·ªÉn th·ªã chi ti·∫øt b√†i t·∫≠p
                if (currentIntegratedData && currentIntegratedData.exercise_data && currentIntegratedData.exercise_data.detailed_exercises) {
                    const detailedExercises = currentIntegratedData.exercise_data.detailed_exercises;
                    
                    // T√¨m t√™n m√¥n h·ªçc ƒë√∫ng (c√≥ th·ªÉ kh√°c gi·ªØa API danh s√°ch v√† chi ti·∫øt)
                    let actualCourseName = courseName;
                    if (!detailedExercises[courseName]) {
                        // Th·ª≠ t√¨m v·ªõi t√™n r√∫t g·ªçn
                        const possibleNames = Object.keys(detailedExercises);
                        actualCourseName = possibleNames.find(name => 
                            name.includes(courseName.split(' ')[0]) || courseName.includes(name.split(' ')[0])
                        ) || courseName;
                    }
                    
                    const courseExercises = detailedExercises[actualCourseName];
                    
                    if (courseExercises) {
                        let html = `
                            <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #667eea; animation: slideDown 0.3s ease;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="color: #667eea; margin: 0;">üìù Chi Ti·∫øt B√†i T·∫≠p - ${courseName}</h4>
                                    <button onclick="toggleExerciseDetails('${courseName.replace(/'/g, "\\'")}', ${studentId})" 
                                            style="background: #f44336; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                                        ‚úï ƒê√≥ng
                                    </button>
                                </div>
                        `;
                        
                        // T√≠nh ƒëi·ªÉm trung b√¨nh m√¥n h·ªçc t·ª´ c√°c k·ªπ nƒÉng
                        const skillScores = Object.values(courseExercises).map(skill => skill.avg_score);
                        const courseAvg = (skillScores.reduce((a, b) => a + b, 0) / skillScores.length);
                        
                        html += `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h5 style="margin: 0 0 10px 0;">üìä ƒêi·ªÉm Trung B√¨nh M√¥n H·ªçc</h5>
                                <div style="font-size: 36px; font-weight: bold;">${courseAvg}/10</div>
                                <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">
                                    T√≠nh t·ª´ ${Object.keys(courseExercises).length} k·ªπ nƒÉng
                                </div>
                            </div>
                        `;
                        
                        Object.entries(courseExercises).forEach(([skill, skillData]) => {
                            const avgScore = skillData.avg_score;
                            let scoreColor = '#4CAF50';
                            if (avgScore < 5.0) scoreColor = '#f44336';
                            else if (avgScore < 7.0) scoreColor = '#FF9800';
                            else if (avgScore < 8.0) scoreColor = '#2196F3';
                            
                            html += `
                                <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid ${scoreColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <h5 style="color: #333; margin: 0;">‚úèÔ∏è ${skill}</h5>
                                        <span style="background: ${scoreColor}; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                                            ${avgScore}/10
                                        </span>
                                    </div>
                                    <p style="color: #666; font-size: 14px; margin-bottom: 12px;">T·ªïng s·ªë b√†i: ${skillData.total_exercises}</p>
                                    
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                            <thead>
                                                <tr style="background: #f5f5f5;">
                                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">B√†i</th>
                                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">ƒêi·ªÉm</th>
                                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Th·ªùi gian</th>
                                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Tr·∫°ng th√°i</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                            `;
                            
                            skillData.exercises.forEach(ex => {
                                const score = ex.score;
                                let scoreStyle = 'color: #4CAF50;';
                                if (score < 5.0) scoreStyle = 'color: #f44336; font-weight: bold;';
                                else if (score < 7.0) scoreStyle = 'color: #FF9800;';
                                else if (score < 8.0) scoreStyle = 'color: #2196F3;';
                                
                                const statusIcon = ex.is_anomaly ? '‚ö†Ô∏è' : '‚úì';
                                const statusColor = ex.is_anomaly ? '#f44336' : '#4CAF50';
                                const statusText = ex.is_anomaly ? (ex.anomaly_reasons || 'B·∫•t th∆∞·ªùng') : 'B√¨nh th∆∞·ªùng';
                                
                                html += `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${ex.exercise_number}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #ddd; ${scoreStyle}">${score.toFixed(1)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${ex.completion_time.toFixed(1)} ph√∫t</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #ddd; color: ${statusColor};" title="${statusText}">
                                            ${statusIcon}
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            const avgTime = skillData.exercises.reduce((sum, ex) => sum + ex.completion_time, 0) / skillData.exercises.length;
                            const passedCount = skillData.exercises.filter(ex => ex.score >= 5.0).length;
                            const passRate = (passedCount / skillData.exercises.length * 100).toFixed(0);
                            
                            html += `
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div style="margin-top: 12px; padding: 10px; background: #fff; border-radius: 5px; font-size: 12px; color: #666; border: 1px solid #e0e0e0;">
                                        <strong>Th·ªëng k√™:</strong> 
                                        ƒêi·ªÉm TB: ${avgScore} | 
                                        Th·ªùi gian TB: ${avgTime.toFixed(1)} ph√∫t | 
                                        T·ª∑ l·ªá ƒë·∫°t: ${passRate}% (${passedCount}/${skillData.exercises.length})
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                        container.innerHTML = html;
                        container.style.display = 'block';
                        
                        // Scroll ƒë·∫øn v·ªã tr√≠ chi ti·∫øt
                        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
            } else {
                // ·∫®n ƒëi
                container.style.display = 'none';
            }
        }
        
        async function toggleTimeDetails(courseName, studentId) {
            const containerId = `timeDetails_${courseName.replace(/\s+/g, '_')}`;
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            // ƒê√≥ng t·∫•t c·∫£ c√°c chi ti·∫øt b√†i t·∫≠p v√† th·ªùi gian kh√°c
            Object.keys(COURSES).forEach(course => {
                const otherExerciseId = `exerciseDetails_${course.replace(/\s+/g, '_')}`;
                const otherTimeId = `timeDetails_${course.replace(/\s+/g, '_')}`;
                const otherExercise = document.getElementById(otherExerciseId);
                const otherTime = document.getElementById(otherTimeId);
                if (otherExercise) {
                    otherExercise.style.display = 'none';
                }
                if (otherTime && otherTimeId !== containerId) {
                    otherTime.style.display = 'none';
                }
            });
            
            // Toggle hi·ªÉn th·ªã m√¥n hi·ªán t·∫°i
            if (container.style.display === 'none' || container.style.display === '') {
                // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu, load t·ª´ API
                if (!currentIntegratedData) {
                    try {
                        const response = await fetch(`${API_BASE}/api/student/${studentId}`);
                        const data = await response.json();
                        currentIntegratedData = data.integrated_data;
                    } catch (error) {
                        alert('L·ªói khi t·∫£i d·ªØ li·ªáu th·ªùi gian: ' + error.message);
                        return;
                    }
                }
                
                // Hi·ªÉn th·ªã chi ti·∫øt th·ªùi gian
                if (currentIntegratedData && currentIntegratedData.exercise_data && currentIntegratedData.exercise_data.detailed_exercises) {
                    const detailedExercises = currentIntegratedData.exercise_data.detailed_exercises;
                    
                    // T√¨m t√™n m√¥n h·ªçc ƒë√∫ng (c√≥ th·ªÉ kh√°c gi·ªØa API danh s√°ch v√† chi ti·∫øt)
                    let actualCourseName = courseName;
                    if (!detailedExercises[courseName]) {
                        // Th·ª≠ t√¨m v·ªõi t√™n r√∫t g·ªçn
                        const possibleNames = Object.keys(detailedExercises);
                        actualCourseName = possibleNames.find(name => 
                            name.includes(courseName.split(' ')[0]) || courseName.includes(name.split(' ')[0])
                        ) || courseName;
                    }
                    
                    const courseExercises = detailedExercises[actualCourseName];
                    
                    if (courseExercises) {
                        let html = `
                            <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #FF9800; animation: slideDown 0.3s ease;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="color: #FF9800; margin: 0;">‚è±Ô∏è Chi Ti·∫øt Th·ªùi Gian - ${courseName}</h4>
                                    <button onclick="toggleTimeDetails('${courseName.replace(/'/g, "\\'")}', ${studentId})" 
                                            style="background: #f44336; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                                        ‚úï ƒê√≥ng
                                    </button>
                                </div>
                        `;
                        
                        // T√≠nh t·ªïng th·ªùi gian m√¥n h·ªçc
                        let totalTime = 0;
                        let totalExercises = 0;
                        Object.values(courseExercises).forEach(skill => {
                            skill.exercises.forEach(ex => {
                                totalTime += ex.completion_time;
                                totalExercises++;
                            });
                        });
                        
                        const avgTime = totalTime / totalExercises;
                        const totalHours = Math.floor(totalTime / 60);
                        const totalMinutes = Math.round(totalTime % 60);
                        
                        html += `
                            <div style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h5 style="margin: 0 0 10px 0;">‚è±Ô∏è T·ªïng Th·ªùi Gian M√¥n H·ªçc</h5>
                                <div style="font-size: 36px; font-weight: bold;">${totalHours}h ${totalMinutes}m</div>
                                <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">
                                    Trung b√¨nh: ${avgTime.toFixed(1)} ph√∫t/b√†i | T·ªïng ${totalExercises} b√†i t·∫≠p
                                </div>
                            </div>
                        `;
                        
                        Object.entries(courseExercises).forEach(([skill, skillData]) => {
                            const skillTotalTime = skillData.exercises.reduce((sum, ex) => sum + ex.completion_time, 0);
                            const skillAvgTime = skillTotalTime / skillData.exercises.length;
                            const skillHours = Math.floor(skillTotalTime / 60);
                            const skillMinutes = Math.round(skillTotalTime % 60);
                            
                            // X√°c ƒë·ªãnh m√†u d·ª±a tr√™n th·ªùi gian trung b√¨nh
                            let timeColor = '#4CAF50'; // Xanh l√° - th·ªùi gian h·ª£p l√Ω
                            if (skillAvgTime < 5) timeColor = '#f44336'; // ƒê·ªè - qu√° nhanh
                            else if (skillAvgTime < 15) timeColor = '#FF9800'; // Cam - h∆°i nhanh
                            else if (skillAvgTime > 120) timeColor = '#9C27B0'; // T√≠m - qu√° l√¢u
                            else if (skillAvgTime > 60) timeColor = '#2196F3'; // Xanh d∆∞∆°ng - h∆°i l√¢u
                            
                            html += `
                                <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid ${timeColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <h5 style="color: #333; margin: 0;">‚è±Ô∏è ${skill}</h5>
                                        <span style="background: ${timeColor}; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                                            ${skillHours}h ${skillMinutes}m
                                        </span>
                                    </div>
                                    <p style="color: #666; font-size: 14px; margin-bottom: 12px;">
                                        Trung b√¨nh: ${skillAvgTime.toFixed(1)} ph√∫t/b√†i | T·ªïng: ${skillData.total_exercises} b√†i
                                    </p>
                                    
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                            <thead>
                                                <tr style="background: #f5f5f5;">
                                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">B√†i</th>
                                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Th·ªùi gian</th>
                                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">ƒêi·ªÉm</th>
                                                    <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">ƒê√°nh gi√°</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                            `;
                            
                            skillData.exercises.forEach(ex => {
                                const time = ex.completion_time;
                                let timeStyle = 'color: #4CAF50;';
                                let timeEval = 'H·ª£p l√Ω';
                                
                                if (time < 5) {
                                    timeStyle = 'color: #f44336; font-weight: bold;';
                                    timeEval = 'Qu√° nhanh ‚ö†Ô∏è';
                                } else if (time < 15) {
                                    timeStyle = 'color: #FF9800;';
                                    timeEval = 'H∆°i nhanh';
                                } else if (time > 120) {
                                    timeStyle = 'color: #9C27B0; font-weight: bold;';
                                    timeEval = 'Qu√° l√¢u ‚ö†Ô∏è';
                                } else if (time > 60) {
                                    timeStyle = 'color: #2196F3;';
                                    timeEval = 'H∆°i l√¢u';
                                }
                                
                                const hours = Math.floor(time / 60);
                                const minutes = Math.round(time % 60);
                                const timeDisplay = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                                
                                html += `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${ex.exercise_number}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #ddd; ${timeStyle}">${timeDisplay}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${ex.score.toFixed(1)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #ddd; font-size: 11px;">${timeEval}</td>
                                    </tr>
                                `;
                            });
                            
                            // Ph√¢n t√≠ch th·ªùi gian
                            const fastCount = skillData.exercises.filter(ex => ex.completion_time < 15).length;
                            const slowCount = skillData.exercises.filter(ex => ex.completion_time > 60).length;
                            const normalCount = skillData.exercises.length - fastCount - slowCount;
                            
                            html += `
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div style="margin-top: 12px; padding: 10px; background: #fff; border-radius: 5px; font-size: 12px; color: #666; border: 1px solid #e0e0e0;">
                                        <strong>Ph√¢n t√≠ch:</strong> 
                                        Nhanh (<15m): ${fastCount} b√†i | 
                                        B√¨nh th∆∞·ªùng: ${normalCount} b√†i | 
                                        Ch·∫≠m (>60m): ${slowCount} b√†i
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                        container.innerHTML = html;
                        container.style.display = 'block';
                        
                        // Scroll ƒë·∫øn v·ªã tr√≠ chi ti·∫øt
                        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
            } else {
                // ·∫®n ƒëi
                container.style.display = 'none';
            }
        }
        
        function closeModal() {
            document.getElementById('studentModal').style.display = 'none';
            currentIntegratedData = null; // Reset d·ªØ li·ªáu khi ƒë√≥ng modal
        }
        
        // H√†m l·ªçc m√¥n h·ªçc trong modal chi ti·∫øt
        function filterModalCourses(studentId) {
            const filterSelect = document.getElementById(`modalCourseFilter_${studentId}`);
            const selectedCourse = filterSelect ? filterSelect.value : 'all';
            
            // L·∫•y t·∫•t c·∫£ c√°c div m√¥n h·ªçc trong modal
            const courseItems = document.querySelectorAll('.course-detail-item');
            
            courseItems.forEach(item => {
                const courseName = item.getAttribute('data-course');
                if (selectedCourse === 'all' || courseName === selectedCourse) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // C·∫≠p nh·∫≠t b·∫£ng ph√¢n t√≠ch n·∫øu c√≥
            if (typeof updateScoreTable === 'function') {
                // ƒê·ªìng b·ªô v·ªõi b·ªô l·ªçc trong b·∫£ng ph√¢n t√≠ch
                const scoreTableFilter = document.getElementById(`courseFilter_${studentId}`);
                if (scoreTableFilter) {
                    scoreTableFilter.value = selectedCourse;
                    updateScoreTable(studentId);
                }
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('studentModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // T·ª± ƒë·ªông load khi trang ƒë∆∞·ª£c m·ªü
        window.onload = () => {
            loadStudents();
        };
    </script>
</body>
</html>






